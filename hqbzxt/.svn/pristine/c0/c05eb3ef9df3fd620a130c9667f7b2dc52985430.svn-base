<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.goods.OrgSkuMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.goods.OrgSku" >
    <id column="ID" property="orgSkuid" jdbcType="DECIMAL" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="FK_SKUID" property="skuid" jdbcType="VARCHAR" />
    <result column="SKUCODE" property="skuCode" jdbcType="VARCHAR" />
    <result column="PROPERTY" property="property" jdbcType="VARCHAR" />
    <result column="GOODSID" property="goodsid" jdbcType="VARCHAR" />
    <result column="GOOSCODE" property="goosCode" jdbcType="VARCHAR" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="ALIASNAME" property="aliasName" jdbcType="VARCHAR" />
    <result column="FK_GOODSTYPEID" property="goodsTypeid" jdbcType="DECIMAL" />
    <result column="GOODSTYPENAME" property="goodsTypeName" jdbcType="VARCHAR" />
    <result column="UNITBASIC" property="unit" jdbcType="VARCHAR" />
    <result column="UNIT" property="auixUnit" jdbcType="VARCHAR" />
    <result column="RATE" property="auixRate" jdbcType="DECIMAL" />
    <result column="PRICE" property="price" jdbcType="DECIMAL" />
    <result column="PRICE_BASIC" property="priceBasic" jdbcType="DECIMAL" />
    <result column="COSTPRICE" property="costPrice" jdbcType="DECIMAL" />
    <result column="COSTPRICE_BASIC" property="costPriceBasic" jdbcType="DECIMAL" />
    <result column="QTY" property="qty" jdbcType="VARCHAR" />
    <result column="QTYBASIC" property="qtyBasic" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="DELETESTATUS" property="deleteStatus" jdbcType="DECIMAL" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="LASTOPUSER" property="lastOpUser" jdbcType="VARCHAR" />
    <result column="LASTOPDATE" property="lastOpDate" jdbcType="TIMESTAMP" />
    <result column="PIC_URL" property="picUrl" jdbcType="VARCHAR" />
    <result column="THUMBNAIL_URL" property="thumbnailUrl" jdbcType="VARCHAR" />
    <result column="SPEC_INFO" property="specInfo" jdbcType="VARCHAR" />
  </resultMap>
  <sql id="Base_Column_List" >
    ID, FK_ORGID, FK_SKUID, FK_GOODSTYPEID, UNIT, RATE, PRICE, PRICE_BASIC, COSTPRICE, 
    COSTPRICE_BASIC, QTY, STATUS, DELETESTATUS, CREATOR, CREATEDATE, LASTOPUSER, LASTOPDATE,SPEC_INFO
  </sql>
  <sql id="param">
  	<if test="typeid!=null">
	  	  and os.FK_GOODSTYPEID=#{typeid,jdbcType=DECIMAL}
	  </if>
	  <if test="orgid!=null">
	  	  and os.FK_ORGID=#{orgid,jdbcType=DECIMAL}
	  </if>
	  <if test="goodsid!=null">
	  	  and g.GOODSID=#{goodsid,jdbcType=DECIMAL}
	  </if>
	  <if test="status!=null">
	  	  and os.STATUS=#{status,jdbcType=DECIMAL}
	  </if>
	  <if test="name!=null and name!=''">
	  	and instr(g.GOODSNAME||';'||g.ALIASNAME,#{name,jdbcType=VARCHAR})>0
	  </if>
	  <if test="spec!=null and spec!=''">
	  	and instr(s.PROPERTY||';'||s.SPEC,#{spec,jdbcType=VARCHAR})>0
	  </if>
	  <if test="orgName!=null and orgName!=''">
	  	and exists(select 1 from ORGANIZATION o 
	  			   where instr(o.NAME||';'||s.SPEC,#{orgName,jdbcType=VARCHAR})>0 and o.ORGID=os.FK_ORGID)
	  </if>
  </sql>
  
  <sql id="orderBy">
  	<choose>
  		<when test="orderBy!=null and orderBy!=''">
  			<choose>
		  		<when test="orderBy=='goodsName' or orderBy=='aliasName' or orderBy=='goodsTypeName' or orderBy=='unit' or
		  					orderBy=='auixUnit' or orderBy=='creator' or orderBy=='lastOpUser'">
		  			NLSSORT(#{orderBy},'NLS_SORT=SCHINESE_PINYIN_M') 
		  		</when>
		  		<otherwise>
		  			${orderBy}
		  		</otherwise>
		  	</choose>
		  	<if test="orderType==1">
		  		desc
		  	</if>
  		</when>
  		<otherwise>
  			GOOSCODE,ID
  		</otherwise>
  	</choose>
  </sql>
  
  <select id="selectByPrimaryKey" parameterType="java.lang.Integer" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from ORG_SKU
    where ID = #{orgSkuid,jdbcType=DECIMAL}
  </select>
  
  <select id="getOrgSkuByOrg" parameterType="java.lang.Integer" resultMap="BaseResultMap">
  	select <include refid="Base_Column_List" />
    from ORG_SKU
    where FK_ORGID = #{orgid,jdbcType=DECIMAL}
  </select>
  
  <select id="getList" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select * from (
	  	select os.ID, os.FK_ORGID,os.FK_SKUID,os.FK_GOODSTYPEID,os.UNIT,os.RATE,os.PRICE,
	  	os.PRICE_BASIC, os.COSTPRICE,os.COSTPRICE_BASIC,floor(os.QTY) as qty,os.STATUS,
	  	os.DELETESTATUS,os.CREATOR,os.CREATEDATE,os.LASTOPUSER,os.LASTOPDATE,os.SPEC_INFO,
	  	o.NAME as ORGNAME,s.SKUCODE,s.PROPERTY,g.GOODSID,g.CODE as GOOSCODE,g.GOODSNAME,g.ALIASNAME,g.UNIT as UNITBASIC,
	  		   t.TYPENAME as GOODSTYPENAME,p.PIC_URL,p.THUMBNAIL_URL
	  	from ORG_SKU os,ORGANIZATION o,SKU s,GOODS g,GOODSTYPE t,SKUPIC  p
	  	where os.FK_ORGID=o.ORGID and os.FK_SKUID=s.SKUID and s.FK_GOODSID=g.GOODSID  and s.SKUID = p.FK_SKUID
	  	and os.FK_GOODSTYPEID=t.TYPEID and os.DELETESTATUS=0
		  	  <include refid="param"/>
	) order by <include refid="orderBy"/>
  </select>
  
  <update id="updateStatus" parameterType="com.yj.hqbz.model.goods.OrgSku">
  	update ORG_SKU
  	set STATUS=#{status,jdbcType=DECIMAL},
  		LASTOPUSER=#{lastOpUser,jdbcType=VARCHAR},
  		LASTOPDATE=#{lastOpDate,jdbcType=TIMESTAMP}
  	where ID = #{orgSkuid,jdbcType=DECIMAL}
  </update>
  <update id="deleteOrgSku" parameterType="com.yj.hqbz.model.goods.OrgSku">
  	update ORG_SKU
  	set DELETESTATUS=#{deleteStatus,jdbcType=DECIMAL},
  		LASTOPUSER=#{lastOpUser,jdbcType=VARCHAR},
  		LASTOPDATE=#{lastOpDate,jdbcType=TIMESTAMP}
  	where ID = #{orgSkuid,jdbcType=DECIMAL}
  </update>
  
  
  <insert id="insertOrgSku" parameterType ="com.yj.hqbz.model.goods.OrgSku">
  	insert into ORG_SKU(ID, FK_ORGID, FK_SKUID, FK_GOODSTYPEID, UNIT, RATE, PRICE, PRICE_BASIC, COSTPRICE, 
    COSTPRICE_BASIC, QTY, STATUS, DELETESTATUS, CREATOR, CREATEDATE,SPEC_INFO)
  	values(ORG_SKU_SEQ_ID.nextval,#{orgid,jdbcType=DECIMAL},#{skuid,jdbcType=VARCHAR},
  	#{goodsTypeid,jdbcType=DECIMAL},#{auixUnit,jdbcType=VARCHAR},#{auixRate,jdbcType=DECIMAL},
  	#{price,jdbcType=DECIMAL},#{priceBasic,jdbcType=DECIMAL},#{costPrice,jdbcType=DECIMAL},
  	#{costPriceBasic,jdbcType=DECIMAL},#{qty,jdbcType=VARCHAR},#{status,jdbcType=DECIMAL},0,
  	#{creator,jdbcType=VARCHAR},sysdate,#{specInfo,jdbcType=VARCHAR})
  </insert>
  
  <update id="updateOrgSku" parameterType ="com.yj.hqbz.model.goods.OrgSku">
  	update ORG_SKU
  	set PRICE = #{price,jdbcType=DECIMAL},
  		PRICE_BASIC = #{priceBasic,jdbcType=DECIMAL},
  		COSTPRICE = #{costPrice,jdbcType=DECIMAL},
  		COSTPRICE_BASIC = #{costPriceBasic,jdbcType=DECIMAL},
  		QTY = #{qty,jdbcType=VARCHAR},
  		LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
  		LASTOPDATE = sysdate
  	where ID = #{orgSkuid,jdbcType=VARCHAR}
  </update>
  
  <select id="selectSellerOrgByCustomerAndGoods" parameterType="java.util.Map" resultType="java.util.Map">
  	select distinct o.orgid,o.name,min(orgsku.price_basic) as lower,max(orgSku.price_basic) as high
	from organization o,SKU sku,ORG_SKU orgSku
	where o.orgid= orgSku.fk_orgid
		and orgsku.status=0
		and o.status=0
		and orgSku.fk_skuid = sku.skuid and sku.fk_goodsid = #{goodsid,jdbcType=VARCHAR}
		and exists (select 1 from ORG_RELATIONSHIP ship where (orgsku.fk_orgid=ship.fk_orgnorgid and ship.fk_targetorgid=#{orgid,jdbcType=DECIMAL}) 
		or (orgsku.fk_orgid=ship.fk_targetorgid and ship.fk_orgnorgid=#{orgid,jdbcType=DECIMAL}))
	group by orgid,name
  </select>
  
  <select id="getOrgSkuBySkuId" parameterType="java.lang.String" resultMap="BaseResultMap" >
  	select <include refid="Base_Column_List" />
    from ORG_SKU
    where FK_SKUID = #{skuid,jdbcType=VARCHAR}
    and STATUS = 0
  </select>
  
  <select id="getOrgSkuSpecsByParam" parameterType="java.util.Map" resultMap="BaseResultMap" >
  	select <include refid="Base_Column_List" />
    from ORG_SKU
    where FK_SKUID = #{skuid,jdbcType=VARCHAR}
    <if test="orgid!=-1">
    	 and FK_ORGID = #{orgid,jdbcType=DECIMAL}
    </if>   
    <choose>
    	<when test="deleteStatus == 0">
    	and DELETESTATUS = 0
    	</when>
    	<otherwise>
    	and STATUS = 0
    	</otherwise>
    </choose>
  </select>
  
  <select id="getOrgSkuByGoodsId" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select 
  	t.ID, t.FK_ORGID, t.FK_SKUID, t.FK_GOODSTYPEID, t.UNIT, t.RATE, t.PRICE, t.PRICE_BASIC, t.COSTPRICE, 
    t.COSTPRICE_BASIC, t.QTY, t.STATUS, t.DELETESTATUS, t.CREATOR, t.CREATEDATE, t.LASTOPUSER, t.LASTOPDATE
    from ORG_SKU t
    where STATUS = 0
    and exists (select 1 from SKU ss
     			where ss.FK_GOODSID=#{goodsid,jdbcType=VARCHAR} 
     			and t.FK_SKUID=ss.SKUID )
  </select>
  <update id="updateOrgSkuQtyBySkuId" parameterType ="com.yj.hqbz.model.goods.OrgSku" >
  	update ORG_SKU set QTY = #{qty,jdbcType=DECIMAL} where id=#{orgSkuid,jdbcType=DECIMAL}
  </update>
</mapper>