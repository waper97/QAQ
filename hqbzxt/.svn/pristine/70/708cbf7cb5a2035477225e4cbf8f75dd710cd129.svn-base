<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.schoolOperation.RetentionSampleMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.schoolOperation.RetentionSample" >
    <id column="RSID" property="rsid" jdbcType="VARCHAR" />
    <result column="RSCODE" property="rsCode" jdbcType="VARCHAR" />
    <result column="MENUCODE" property="menuCode" jdbcType="VARCHAR" />
    <result column="DISHNAME" property="dishName" jdbcType="VARCHAR" />
    <result column="RSDATE" property="rsDate" jdbcType="TIMESTAMP" />
    <result column="MENUTYPE" property="menuType" jdbcType="DECIMAL" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="COOKERNAME" property="cookerName" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="QTY" property="qty" jdbcType="VARCHAR" />
    <result column="RS_USER" property="rsUser" jdbcType="VARCHAR" />
    <result column="RS_TIME" property="rsTime" jdbcType="TIMESTAMP" />
    <result column="RS_END_TIME" property="rsEndTime" jdbcType="TIMESTAMP" />
    <result column="PIC_URL" property="picUrl" jdbcType="VARCHAR" />
    <result column="THUMBNAIL_URL" property="thumbnailUrl" jdbcType="VARCHAR" />
    <result column="DELETESTATUS" property="deleteStatus" jdbcType="DECIMAL" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="LASTOPUSER" property="lastOpUser" jdbcType="VARCHAR" />
    <result column="LASTOPDATE" property="lastOpDate" jdbcType="TIMESTAMP" />
    <result column="CONDUCTOR" property="conductor" jdbcType="VARCHAR" />
    <result column="TEMPERATURE" property="temperature" jdbcType="DECIMAL" />
  </resultMap>

	<resultMap id="RetentionSampleAttachmentResultMap" type="com.yj.hqbz.model.schoolOperation.RetentionSampleAttachment">
		<id column="ID" property="attenId"/>
		<result column="FK_RSID" property="rsid"/>
		<result column="PIC_URL" property="picUrl"/>
		<result column="THUMBNAIL_URL" property="thumbnailUrl"/>
	</resultMap>
  <sql id="Base_Column_List" >
    RSID, RSCODE, MENUCODE, DISHNAME, RSDATE, MENUTYPE, FK_ORGID, COOKERNAME, REMARK, 
    QTY, RS_USER, RS_TIME, RS_END_TIME, PIC_URL, THUMBNAIL_URL, DELETESTATUS, CREATOR, 
    CREATEDATE, LASTOPUSER, LASTOPDATE,CONDUCTOR,TEMPERATURE
  </sql>
  <sql id="orderBy">
  	<choose>
  		<when test="orderBy!=null and orderBy!=''">
  			<choose>
		  		<when test="orderBy=='rsUser' or orderBy=='creator' or orderBy=='lastOpUser'">
		  			NLSSORT(#{orderBy},'NLS_SORT=SCHINESE_PINYIN_M') 
		  		</when>
		  		<otherwise>
		  			#{orderBy}
		  		</otherwise>
		  	</choose>
		  	<if test="orderType==1">
		  		desc
		  	</if>
  		</when>
  		<otherwise>
  			r.MENUCODE desc
  		</otherwise>
  	</choose>
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from RETENTION_SAMPLE
    where RSID = #{rsid,jdbcType=VARCHAR}
  </select>
  <select id="selectByMenuCode" resultMap="BaseResultMap" parameterType="java.lang.String" >
  	select 
    <include refid="Base_Column_List" />
    from RETENTION_SAMPLE
    where MENUCODE = #{menuCode,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.RetentionSample" >
    update RETENTION_SAMPLE
    set DELETESTATUS = #{deleteStatus,jdbcType=DECIMAL},
    	LASTOPUSER=#{lastOpUser,jdbcType=VARCHAR},
	    LASTOPDATE=#{lastOpDate,jdbcType=TIMESTAMP}
    where RSID = #{rsid,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.yj.hqbz.model.schoolOperation.RetentionSample" >
    insert into RETENTION_SAMPLE (RSID, RSCODE, MENUCODE, 
      DISHNAME, RSDATE, MENUTYPE, 
      FK_ORGID, COOKERNAME, REMARK, 
      QTY, RS_USER, RS_TIME, 
      RS_END_TIME, PIC_URL, THUMBNAIL_URL, 
      DELETESTATUS, CREATOR, CREATEDATE, 
      LASTOPUSER, LASTOPDATE,CONDUCTOR,TEMPERATURE)
    values (#{rsid,jdbcType=VARCHAR}, 
      (select 'Y'||to_char(sysdate,'yyyyMMdd')||NVL(TRIM(to_char(max(substr(t.rscode,10))+1,'0009')),'0001')
      from RETENTION_SAMPLE t),
      <choose>
      	<when test="menuCode != null">
      	#{menuCode,jdbcType=VARCHAR},
      	</when>
      	<otherwise>
        (select 'Z'||to_char(sysdate,'yyyyMMddhhmmss')||NVL(TRIM(to_char(max(substr(t.menucode,16))+1,'0009')),'0001')
      	from RETENTION_SAMPLE t where length(t.menucode) = 19),
      	</otherwise>
      </choose> 
      #{dishName,jdbcType=VARCHAR}, #{rsDate,jdbcType=TIMESTAMP}, #{menuType,jdbcType=DECIMAL}, 
      #{orgid,jdbcType=DECIMAL}, #{cookerName,jdbcType=VARCHAR}, #{remark,jdbcType=VARCHAR}, 
      #{qty,jdbcType=VARCHAR}, #{rsUser,jdbcType=VARCHAR}, trunc(#{rsTime,jdbcType=TIMESTAMP},'hh'), 
      #{rsEndTime,jdbcType=TIMESTAMP}, #{picUrl,jdbcType=VARCHAR}, #{thumbnailUrl,jdbcType=VARCHAR}, 
      #{deleteStatus,jdbcType=DECIMAL}, #{creator,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, 
      #{lastOpUser,jdbcType=VARCHAR}, #{lastOpDate,jdbcType=TIMESTAMP}, #{conductor,jdbcType=VARCHAR},
      #{temperature,jdbcType=DECIMAL})
  </insert>
  
  <update id="updateByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.RetentionSample" >
    update RETENTION_SAMPLE
    <set>
    	<if test="dishName !=null">
      	DISHNAME = #{dishName,jdbcType=VARCHAR},
    	</if>
    	<if test="rsDate != null">
    	RSDATE = #{rsDate,jdbcType=TIMESTAMP},
    	</if>
    	<if test="menuType != null">
    	MENUTYPE = #{menuType,jdbcType=DECIMAL},
    	</if>
    	<if test="orgid != null">
    	FK_ORGID = #{orgid,jdbcType=DECIMAL},
    	</if>
    	<if test="cookerName != null">
    	COOKERNAME = #{cookerName,jdbcType=VARCHAR},
    	</if>
    	<if test="remark != null">
    	REMARK = #{remark,jdbcType=VARCHAR},
    	</if>
    	<if test="qty != null">
    	QTY = #{qty,jdbcType=VARCHAR},
    	</if>
    	<if test="rsUser != null">
    	RS_USER = #{rsUser,jdbcType=VARCHAR},
    	</if>
    	<if test="rsTime != null">
    	RS_TIME = trunc(#{rsTime,jdbcType=TIMESTAMP},'hh'),
    	</if>
    	<if test="rsEndTime != null">
    	RS_END_TIME = #{rsEndTime,jdbcType=TIMESTAMP},
    	</if>
    	<if test="picUrl != null">
    	PIC_URL = #{picUrl,jdbcType=VARCHAR},
    	</if>
    	<if test="thumbnailUrl != null">
    	THUMBNAIL_URL = #{thumbnailUrl,jdbcType=VARCHAR},
    	</if>
    	<if test="lastOpUser != null">
    	LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
    	</if>
    	<if test="lastOpDate != null">
    	LASTOPDATE = #{lastOpDate,jdbcType=TIMESTAMP},
    	</if>
    	<if test="conductor != null">
    	CONDUCTOR = #{conductor,jdbcType=VARCHAR},
    	</if>
    	<if test="temperature != null">
    	TEMPERATURE = #{temperature,jdbcType=DECIMAL},
    	</if>
    </set>
    where RSID = #{rsid,jdbcType=VARCHAR}
  </update>
  <select id="getListByParem" parameterType="map" resultMap="BaseResultMap">
  	select 
	    r.RSID, r.RSCODE, r.MENUCODE, r.DISHNAME, r.RSDATE, r.MENUTYPE, r.FK_ORGID, r.COOKERNAME, r.REMARK, 
	    r.QTY,r.RS_USER, r.RS_TIME, r.RS_END_TIME, r.PIC_URL, r.THUMBNAIL_URL, r.DELETESTATUS, r.CREATOR, 
	    r.CREATEDATE, r.LASTOPUSER, r.LASTOPDATE,r.CONDUCTOR,r.TEMPERATURE
    from RETENTION_SAMPLE r
    where r.DELETESTATUS=0
    <if test="menuType !=null">
    	and r.MENUTYPE=#{menuType,jdbcType=DECIMAL}
    </if>
    <if test="beginDate != null">
  		and r.RS_TIME >=#{beginDate,jdbcType=TIMESTAMP}
  	</if>
  	<if test="endDate != null">
  		and r.RS_TIME &lt;=#{endDate,jdbcType=TIMESTAMP}
  	</if>
  	<if test="rsUser !=null">
  		and instr(r.RS_USER,#{rsUser,jdbcType=VARCHAR})>0
  	</if>
  	<choose>
  		<when test="isManager == null">
  			and r.FK_ORGID = #{orgid,jdbcType=DECIMAL}
  		</when>
  		<otherwise>
  			<!-- 是食堂管理员，获取学校机构id,再获取学校所有食堂机构id,获取在该学校食堂的人员 -->
  			and 
			instr(','||(select ob.fk_orgids from ORG_BELONG ob 
						where instr(','||ob.fk_orgids||',' , 
						','||#{orgid,jdbcType=DECIMAL}||',')>0) ||',' , ','||r.FK_ORGID||',')>0
  		</otherwise>
  	</choose>
  	order by <include refid="orderBy" />
  </select>

	<select id="getRentionSampleAttachment" resultMap="RetentionSampleAttachmentResultMap" parameterType="java.lang.String">
			select ID,FK_RSID, PIC_URL,THUMBNAIL_URL from RETENTION_SAMPLE_ATTENCHMENT where FK_RSID = #{rsid}
	</select>
	<insert id="insertAttachment" parameterType="com.yj.hqbz.model.schoolOperation.RetentionSampleAttachment">
		INSERT INTO RETENTION_SAMPLE_ATTENCHMENT
		(ID, FK_RSID, PIC_URL, THUMBNAIL_URL)
		 VALUES (#{attenId}, #{rsid}, #{picUrl}, #{thumbnailUrl})
	</insert>
</mapper>