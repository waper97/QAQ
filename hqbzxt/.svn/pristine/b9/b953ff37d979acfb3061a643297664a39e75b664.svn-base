<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.sporadic.SporadicDetailMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.sporadic.SporadicDetail" >
    <id column="ID" property="detailid" jdbcType="VARCHAR" />
    <result column="FK_INDEXID" property="indexid" jdbcType="VARCHAR" />
    <result column="VOUCHERCODE" property="voucherCode" jdbcType="VARCHAR" />
    <result column="PUTINWAREHOUSE" property="putInWarehouse" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="PURCHASERID" property="purchaserid" jdbcType="VARCHAR" />
    <result column="PURCHASER" property="purchaser" jdbcType="VARCHAR" />
    <result column="FK_GOODSID" property="goodsid" jdbcType="VARCHAR" />
    <result column="GOODSCODE" property="goodsCode" jdbcType="VARCHAR" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="GOODSTYPEID" property="goodsTypeid" jdbcType="DECIMAL" />
    <result column="GOODSTYPENAME" property="goodsTypeName" jdbcType="VARCHAR" />
    <result column="UNIT" property="unit" jdbcType="VARCHAR" />
    <result column="QTY" property="qty" jdbcType="DECIMAL" />
    <result column="PRICE" property="price" jdbcType="DECIMAL" />
    <result column="TOTAL" property="total" jdbcType="DECIMAL" />
    <result column="SUPPLIER" property="supplier" jdbcType="VARCHAR" />
    <result column="PRODATE" property="proDate" jdbcType="TIMESTAMP" />
    <result column="INTERVALDATE" property="intervalDate" jdbcType="TIMESTAMP" />
    <result column="USELIFEDATE" property="uselifeDate" jdbcType="TIMESTAMP" />
    <result column="BUYDATE" property="buyDate" jdbcType="TIMESTAMP" />
    <result column="USEDATE" property="useDate" jdbcType="TIMESTAMP" />
    <result column="TRACEID" property="traceid" jdbcType="VARCHAR" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
  </resultMap>
  <sql id="Base_Column_List" >
    ID, FK_INDEXID, FK_GOODSID, QTY, PRICE, TOTAL
  </sql>
  
  <sql id="param">
  	<if test="goodsName!=null and goodsName!=''">
  		and instr(g.GOODSNAME,#{goodsName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="purchaser!=null and purchaser!=''">
  		and instr(i.PURCHASER,#{purchaser,jdbcType=VARCHAR})>0
  	</if>
  	<if test="goodsTypeid!=null">
  		and exists(select 1 from GOODSTYPE t1 
  		  			   where t1.TYPEID=t.TYPEID
  		  			   start with t1.TYPEID=#{goodsTypeid,jdbcType=DECIMAL}
  							connect by prior t1.TYPEID=t1.FK_PARENTID
  		  			  )
  	
  		<!--and GOODSTYPEID=#{goodsTypeid,jdbcType=DECIMAL}  -->
  	</if>
  	<if test="status==0 or status==1">
  		and i.STATUS=#{status,jdbcType=DECIMAL}
  	</if>
  </sql>
  
  <sql id="orderBy">
  	<choose>
  		<when test="orderBy!=null and orderBy!=''">
  			<choose>
		  		<when test="orderBy=='goodsName' or orderBy=='goodsTypeName' or orderBy=='purchaser'">
		  			NLSSORT(#{orderBy},'NLS_SORT=SCHINESE_PINYIN_M') 
		  		</when>
		  		<otherwise>
		  			#{orderBy}
		  		</otherwise>
		  	</choose>
		  	<if test="orderType==1">
		  		desc
		  	</if>
  		</when>
  		<otherwise>
  			VOUCHERCODE
  		</otherwise>
  	</choose>
  </sql>
  
  <select id="selectByPrimaryKey" parameterType="java.lang.String" resultMap="BaseResultMap">
    select <include refid="Base_Column_List" />
    from SPORADIC_DETAIL
    where ID = #{detailid,jdbcType=VARCHAR}
  </select>
  
  <select id="getSporadicList" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select * from(
	  	select d.*,i.VOUCHERCODE,i.PUTINWAREHOUSE,i.STATUS,i.PURCHASERID,i.PURCHASER,i.CREATEDATE,tr.BUYDATE,
	  		   g.CODE as GOODSCODE,g.GOODSNAME,g.UNIT,t.TYPEID as GOODSTYPEID,t.TYPENAME as GOODSTYPENAME,
	  		   tr.ID as TRACEID
	  	from SPORADIC_INDEX i,SPORADIC_DETAIL d,GOODS_TRACE tr,SPORADIC_GOODS g,GOODSTYPE t
	  	where i.ID=d.FK_INDEXID and i.ID=tr.FK_ORDERID and d.ID=tr.FK_ORDER_DETAILID and tr.TRACE_TYPE=1
	  		  and d.FK_GOODSID=g.GOODSID and g.FK_GOODSTYPEID=t.TYPEID and i.DELETESTATUS=0
	  		  and i.FK_ORGID=#{orgid,jdbcType=DECIMAL} <include refid="param"/>
  	) order by<include refid="orderBy"/>
  </select>
  
  <select id="getSporadicDetail" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select d.*,i.VOUCHERCODE,i.PUTINWAREHOUSE,i.STATUS,i.PURCHASERID,i.PURCHASER,i.CREATEDATE,i.USEDATE,i.REMARK,
	  	   g.CODE as GOODSCODE,g.GOODSNAME,g.UNIT,t.TYPEID as GOODSTYPEID,t.TYPENAME as GOODSTYPENAME,
	  	   tr.SUPPLIER,tr.PRODATE,tr.INTERVALDATE,tr.USELIFEDATE,tr.BUYDATE,tr.ID as TRACEID
	from SPORADIC_INDEX i,SPORADIC_DETAIL d,GOODS_TRACE tr,SPORADIC_GOODS g,GOODSTYPE t
	where i.ID=d.FK_INDEXID and i.ID=tr.FK_ORDERID and d.ID=tr.FK_ORDER_DETAILID and tr.TRACE_TYPE=1
	  	  and d.FK_GOODSID=g.GOODSID and g.FK_GOODSTYPEID=t.TYPEID and i.DELETESTATUS=0
	  	  and d.ID=#{detailid,jdbcType=VARCHAR}
  </select>
  
  <insert id="addDetail" parameterType="com.yj.hqbz.model.sporadic.SporadicDetail">
  	insert into SPORADIC_DETAIL(<include refid="Base_Column_List" />)
  	values (#{detailid,jdbcType=VARCHAR},#{indexid,jdbcType=VARCHAR},#{goodsid,jdbcType=VARCHAR},
  			#{qty,jdbcType=DECIMAL},#{price,jdbcType=DECIMAL},#{total,jdbcType=DECIMAL}
  			)
  </insert>
  
  <update id="updateGoodsByIndexid" parameterType="com.yj.hqbz.model.sporadic.SporadicDetail">
  	update SPORADIC_DETAIL
  	set QTY=#{qty,jdbcType=DECIMAL}, 
  		PRICE=#{price,jdbcType=DECIMAL}, 
  		TOTAL=#{total,jdbcType=DECIMAL}
  	where FK_INDEXID = #{indexid,jdbcType=VARCHAR}
  </update>
</mapper>