<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.schoolOperation.FoodAdditiveMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.schoolOperation.FoodAdditive" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="CODE" property="code" jdbcType="VARCHAR" />
    <result column="LIABLEID" property="aliableid" jdbcType="VARCHAR" />
    <result column="PERSION_LIABLE" property="personAliable" jdbcType="VARCHAR" />
    <result column="MENUTYPE" property="menuType" jdbcType="DECIMAL" />
    <result column="USEDATE" property="useDate" jdbcType="TIMESTAMP" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="FK_OUTDETAILID" property="detailid" jdbcType="VARCHAR" />
    <result column="QTY" property="qty" jdbcType="DECIMAL" />
    <result column="PERCENT" property="percent" jdbcType="DECIMAL" />
    <result column="REMARK" property="remark" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="LASTOPUSER" property="lastOpUser" jdbcType="VARCHAR" />
    <result column="LASTOPDATE" property="lastOpDate" jdbcType="TIMESTAMP" />
    
    <result column="PRODATE" property="prodate" jdbcType="TIMESTAMP" />
    <result column="INTERVALDATE" property="intervaldate" jdbcType="TIMESTAMP" />
    <result column="USELIFEDATE" property="uselifedate" jdbcType="TIMESTAMP" />
    <result column="OUTDATE" property="outDate" jdbcType="TIMESTAMP" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="ALIASNAME" property="aliasName" jdbcType="VARCHAR" />
    <result column="UNIT" property="unit" jdbcType="VARCHAR" />
    <result column="TYPENAME" property="goodsType" jdbcType="VARCHAR" />
    <result column="OUTORDERNO" property="outOrderNo" jdbcType="VARCHAR" />
    <result column="RELORDERNO" property="relOrderNo" jdbcType="VARCHAR" />
    <result column="OUTQTY" property="outQty" jdbcType="DECIMAL" />
    <result column="availableQty" property="availableQty" jdbcType="DECIMAL" />
    <result column="WAREHOUSE" property="warehouse" jdbcType="VARCHAR" />
    <result column="OUTPERSON" property="outPerson" jdbcType="VARCHAR" />
    <result column="PURPOSE" property="purpose" jdbcType="DECIMAL" />
  </resultMap>
  
  
  <resultMap id="AddtiveOutMap" type="com.yj.hqbz.model.schoolOperation.FoodAdditiveOut" >    
    <result column="ID" property="detailid" jdbcType="VARCHAR" />
    <result column="PRODATE" property="prodate" jdbcType="TIMESTAMP" />
    <result column="INTERVALDATE" property="intervaldate" jdbcType="TIMESTAMP" />
    <result column="USELIFEDATE" property="uselifedate" jdbcType="TIMESTAMP" />
    <result column="OUTDATE" property="outDate" jdbcType="TIMESTAMP" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="ALIASNAME" property="aliasName" jdbcType="VARCHAR" />
    <result column="UNIT" property="unit" jdbcType="VARCHAR" />
    <result column="TYPENAME" property="goodsType" jdbcType="VARCHAR" />
    <result column="OUTORDERNO" property="outOrderNo" jdbcType="VARCHAR" />
    <result column="RELORDERNO" property="relOrderNo" jdbcType="VARCHAR" />
    <result column="OUTQTY" property="outQty" jdbcType="DECIMAL" />
    <result column="availableQty" property="availableQty" jdbcType="DECIMAL" />
    <result column="WAREHOUSE" property="warehouse" jdbcType="VARCHAR" />
    <result column="OUTPERSON" property="outPerson" jdbcType="VARCHAR" />
    <result column="PURPOSE" property="purpose" jdbcType="DECIMAL" />
    <result column="GOODSSTATUS" property="goodsStatus" jdbcType="DECIMAL" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    ID, CODE, LIABLEID, PERSION_LIABLE, MENUTYPE, USEDATE, FK_ORGID, FK_OUTDETAILID, 
    QTY, PERCENT, REMARK, STATUS, CREATOR, CREATEDATE, LASTOPUSER, LASTOPDATE
  </sql>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
	select a.*,g.goodsname,gt.typename,g.unit,bi.vouchercode as "outOrderNo",
		bd.qty as outQty,bi.businessdate as outDate,bd.warehouse,bd.prodate,bd.intervaldate,
		bd.uselifedate,bi.purpose,bi.liableperson as outPerson,i.orderno as relOrderNo
    from FOOD_ADDITIVE a,BVOUCHER_INDEX bi,BVOUCHER_DETAIL bd,GOODS g,GOODSTYPE gt,INVENTORY i
    where a.ID = #{id,jdbcType=VARCHAR}
    	and a.fk_outdetailid = bd.id
    	and bi.id = bd.fk_indexid
    	and bd.fk_goodsid = g.goodsid
    	and g.fk_goodstypeid = gt.typeid
    	and bd.fk_traceid = i.fk_traceid
    	and a.status = 0
    union
    select a.*,g.goodsname,gt.typename,g.unit,bi.vouchercode as "outOrderNo",
		bd.qty as outQty,bi.businessdate as outDate,bd.warehouse,bd.prodate,bd.intervaldate,
		bd.uselifedate,bi.purpose,bi.liableperson as outPerson,i.orderno as relOrderNo
    from FOOD_ADDITIVE a,BVOUCHER_INDEX bi,BVOUCHER_DETAIL bd,SPORADIC_GOODS g,GOODSTYPE gt,INVENTORY i
    where a.ID = #{id,jdbcType=VARCHAR}
    	and a.fk_outdetailid = bd.id
    	and bi.id = bd.fk_indexid
    	and bd.fk_goodsid = g.goodsid
    	and g.fk_goodstypeid = gt.typeid
    	and bd.fk_traceid = i.fk_traceid
    	and a.status = 0
  </select>
  
  <select id="selectFoodAdditiveListByParam" resultMap="BaseResultMap" parameterType="java.util.Map">
  	select * from (
	  	select a.*,g.goodsname,g.unit
	    from FOOD_ADDITIVE a,BVOUCHER_DETAIL bd,GOODS g
	    where a.fk_outdetailid = bd.id
	    	and bd.fk_goodsid = g.goodsid
	    	<if test="orgid!=null">
	    		and a.FK_ORGID = #{orgid,jdbcType=DECIMAL}
	    	</if>
	    	<if test="menuType!=null">
	    		and a.MENUTYPE = #{menuType,jdbcType=DECIMAL}
	    	</if>
	    	<if test="useDate!=null and useDate!=''">
	    		and to_char(a.USEDATE,'yyyy-MM-dd') = #{useDate,jdbcType=VARCHAR}
	    	</if>
	    	<if test="aliable!=null and aliable!=''">
	    		and instr(a.PERSION_LIABLE,#{aliable})>0
	    	</if>
	    	and a.status = 0
	    	
	    	union
	    	select a.*,g.goodsname,g.unit
		    from FOOD_ADDITIVE a,BVOUCHER_DETAIL bd,SPORADIC_GOODS g
		    where a.fk_outdetailid = bd.id
		    	and bd.fk_goodsid = g.goodsid
		    	<if test="orgid!=null">
		    		and a.FK_ORGID = #{orgid,jdbcType=DECIMAL}
		    	</if>
		    	<if test="menuType!=null">
		    		and a.MENUTYPE = #{menuType,jdbcType=DECIMAL}
		    	</if>
		    	<if test="useDate!=null and useDate!=''">
		    		and to_char(a.USEDATE,'yyyy-MM-dd') = #{useDate,jdbcType=VARCHAR}
		    	</if>
		    	<if test="aliable!=null and aliable!=''">
		    		and instr(a.PERSION_LIABLE,#{aliable})>0
		    	</if>
		    	and a.status = 0
	    )	
    order by CREATEDATE desc
  </select>
  
  
  <select id="getFoodAdditiveOutListByParam" resultMap="AddtiveOutMap" parameterType="java.util.Map">
	select i.*,(i.outQty-i.useQty) as availableQty,
	case when to_char(i.uselifedate,'yyyy-MM-dd') &lt;to_char(sysdate,'yyyy-MM-dd') then '2'
	when to_char(i.intervaldate,'yyyy-MM-dd') &lt; to_char(sysdate,'yyyy-MM-dd') then '1'
	else '0' end  as goodsStatus
 from (
		select bd.ID,g.goodsname,gt.typename,g.unit,bi.vouchercode as outOrderNo,
			bd.qty as outQty,bi.businessdate as outDate,bd.warehouse,bd.prodate,bd.intervaldate,
			bd.uselifedate,bi.purpose,bi.liableperson as outPerson,i.orderno as relOrderNo,nvl(sum(a.qty),0) as useQty
	    from BVOUCHER_INDEX bi,SPORADIC_GOODS g,GOODSTYPE gt,INVENTORY i,BVOUCHER_DETAIL bd
	    left join FOOD_ADDITIVE a on bd.id = a.fk_outdetailid
	    where bi.id = bd.fk_indexid
	    	and bi.STATUS = 0
	    	and bi.VOUCHERTYPE = 1
	    	and bd.fk_goodsid = g.goodsid
	    	and g.fk_goodstypeid = gt.typeid
	    	and bd.fk_traceid = i.fk_traceid
	    <if test="orgid!=null">
	    	and bi.FK_ORGID = #{orgid,jdbcType=DECIMAL}
	    </if>
	    <if test="goodsTypeid!=null">
	    and exists(select 1 from (select * from GOODSTYPE 
        	WHERE STATUS = 0 
      		start with TYPEID  = #{goodsTypeid,jdbcType=DECIMAL}
      		connect by prior  TYPEID = FK_PARENTID ) t where t.typeid=g.fk_goodstypeid)  
	    </if>
	  	group by bd.ID,g.goodsname,gt.typename,g.unit,bi.vouchercode,
			bd.qty,bi.businessdate,bd.warehouse,bd.prodate,bd.intervaldate,
			bd.uselifedate,bi.purpose,bi.liableperson,i.orderno
			
		union
		
		select bd.ID,g.goodsname,gt.typename,g.unit,bi.vouchercode as outOrderNo,
			bd.qty as outQty,bi.businessdate as outDate,bd.warehouse,bd.prodate,bd.intervaldate,
			bd.uselifedate,bi.purpose,bi.liableperson as outPerson,i.orderno as relOrderNo,nvl(sum(a.qty),0) as useQty
	    from BVOUCHER_INDEX bi,GOODS g,GOODSTYPE gt,INVENTORY i,BVOUCHER_DETAIL bd
	    left join FOOD_ADDITIVE a on bd.id = a.fk_outdetailid
	    where bi.id = bd.fk_indexid
	    	and bi.STATUS = 0
	    	and bi.VOUCHERTYPE = 1
	    	and bd.fk_goodsid = g.goodsid
	    	and g.fk_goodstypeid = gt.typeid
	    	and bd.fk_traceid = i.fk_traceid
	    <if test="orgid!=null">
	    	and bi.FK_ORGID = #{orgid,jdbcType=DECIMAL}
	    </if>
	    <if test="goodsTypeid!=null">
	    and exists(select 1 from (select * from GOODSTYPE 
        	WHERE STATUS = 0 
      		start with TYPEID  = #{goodsTypeid,jdbcType=DECIMAL} 
      		connect by prior  TYPEID = FK_PARENTID) t where t.typeid=g.fk_goodstypeid)
	    </if>
	  	group by bd.ID,g.goodsname,gt.typename,g.unit,bi.vouchercode,
			bd.qty,bi.businessdate,bd.warehouse,bd.prodate,bd.intervaldate,
			bd.uselifedate,bi.purpose,bi.liableperson,i.orderno
		
	  ) i
    where (i.outqty>i.useQty or i.useQty is null)
    order by i.outDate
  </select>
  
  <update id="deleteByPrimaryKey" parameterType="java.lang.String" >
    update FOOD_ADDITIVE
    set STATUS = 1
    where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <insert id="insert" parameterType="com.yj.hqbz.model.schoolOperation.FoodAdditive" >
    insert into FOOD_ADDITIVE (ID, CODE, LIABLEID, 
      PERSION_LIABLE, MENUTYPE, USEDATE, 
      FK_ORGID, FK_OUTDETAILID, QTY, 
      PERCENT, REMARK, STATUS, 
      CREATOR, CREATEDATE)
    values (#{id,jdbcType=VARCHAR}, #{code,jdbcType=VARCHAR}, #{aliableid,jdbcType=VARCHAR}, 
      #{personAliable,jdbcType=VARCHAR}, #{menuType,jdbcType=DECIMAL}, #{useDate,jdbcType=TIMESTAMP}, 
      #{orgid,jdbcType=DECIMAL}, #{detailid,jdbcType=VARCHAR}, #{qty,jdbcType=DECIMAL}, 
      #{percent,jdbcType=DECIMAL}, #{remark,jdbcType=VARCHAR}, #{status,jdbcType=DECIMAL}, 
      #{creator,jdbcType=VARCHAR},sysdate)
  </insert>
  
  <update id="updateByPrimaryKeySelective" parameterType="com.yj.hqbz.model.schoolOperation.FoodAdditive" >
    update FOOD_ADDITIVE
    <set >      
      <if test="aliableid != null" >
        LIABLEID = #{aliableid,jdbcType=VARCHAR},
      </if>
      <if test="personAliable != null" >
        PERSION_LIABLE = #{personAliable,jdbcType=VARCHAR},
      </if>
      <if test="menuType != null" >
        MENUTYPE = #{menuType,jdbcType=DECIMAL},
      </if>
      <if test="useDate != null" >
        USEDATE = #{useDate,jdbcType=TIMESTAMP},
      </if>
      <if test="qty != null" >
        QTY = #{qty,jdbcType=DECIMAL},
      </if>
      <if test="percent != null" >
        PERCENT = #{percent,jdbcType=DECIMAL},
      </if>
      <if test="remark != null" >
        REMARK = #{remark,jdbcType=VARCHAR},
      </if>      
      <if test="lastOpUser != null" >
        LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
      </if>
      <if test="lastOpDate!= null" >
        LASTOPDATE = #{lastOpDate,jdbcType=TIMESTAMP},
      </if>
    </set>
    where ID = #{id,jdbcType=VARCHAR}
  </update>
 
</mapper>