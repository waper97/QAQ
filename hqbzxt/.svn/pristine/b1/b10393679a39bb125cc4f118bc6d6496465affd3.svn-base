<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.schoolOperation.AttendanceIndexMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.schoolOperation.AttendanceIndex" >
    <id column="INDEXID" property="indexid" jdbcType="VARCHAR" />
    <result column="ATT_DATE" property="attDate" jdbcType="TIMESTAMP" />
    <result column="ATT_USERID" property="userid" jdbcType="VARCHAR" />
    <result column="ATT_NAME" property="name" jdbcType="VARCHAR" />
    <result column="COUNT" property="count" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="NAME" property="orgName" jdbcType="VARCHAR" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="LASTOPUSER" property="lastOpUser" jdbcType="VARCHAR" />
    <result column="LASTOPDATE" property="lastOpDate" jdbcType="TIMESTAMP" />
    <result column="SUMMARY" property="summary" jdbcType="VARCHAR" />
    <result column="OKPEOPLE" property="okPeople" jdbcType="DECIMAL" />
    <result column="NOTOK" property="notOk" jdbcType="DECIMAL" />
    <result column="LACK" property="lack" jdbcType="DECIMAL" />    
  </resultMap>
  <sql id="Base_Column_List" >
    INDEXID, ATT_DATE, ATT_USERID, COUNT, STATUS, FK_ORGID, CREATOR, CREATEDATE, LASTOPUSER, 
    LASTOPDATE
  </sql>
  <sql id="getResult">
  	nvl((select count(d.result) from attendance_detail d where t.INDEXID=d.FK_INDEXID and d.result=0),0) as "okPeople",
    nvl((select count(d.result) from attendance_detail d where t.INDEXID=d.FK_INDEXID and d.result in (1,2,3)),0) as "notOk",
    nvl((select count(d.result) from attendance_detail d where t.INDEXID=d.FK_INDEXID and d.result in (5,6,7)),0) as "lack"
  </sql>
  <sql id="getSummary">
  case when t.count=(select count(d.result) from attendance_detail d where t.INDEXID=d.FK_INDEXID and d.result=0) then '全部合格'
       when t.count=(select count(d.result) from attendance_detail d where t.INDEXID=d.FK_INDEXID and d.result in (1,2,3)) then '全部不合格'
       else '部分不合格' end as "summary"
  </sql>
  <sql id="orderBy">
  	<choose>
  		<when test="orderBy!=null and orderBy!=''">
  			<choose>
		  		<when test="orderBy=='name' or orderBy=='orgName' or orderBy=='creator' or orderBy=='lastOpUser'">
		  			NLSSORT(#{orderBy},'NLS_SORT=SCHINESE_PINYIN_M') 
		  		</when>
		  		<otherwise>
		  			#{orderBy}
		  		</otherwise>
		  	</choose>
		  	<if test="orderType==1">
		  		desc
		  	</if>
  		</when>
  		<otherwise>
  			t.CREATEDATE desc
  		</otherwise>
  	</choose>
  </sql>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />,
    <include refid="getResult" />,
    <include refid="getSummary" />
    from ATTENDANCE_INDEX t
    where INDEXID = #{indexid,jdbcType=VARCHAR}
  </select>
  
  <delete id="deleteByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.AttendanceIndex" >
    update ATTENDANCE_INDEX
    set STATUS = #{status,jdbcType=DECIMAL},
    	LASTOPUSER=#{lastOpUser,jdbcType=VARCHAR},
	    LASTOPDATE=#{lastOpDate,jdbcType=TIMESTAMP}
    where INDEXID = #{indexid,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.yj.hqbz.model.schoolOperation.AttendanceIndex" >
    insert into ATTENDANCE_INDEX (INDEXID, ATT_DATE, ATT_USERID, 
      COUNT, STATUS, FK_ORGID, 
      CREATOR, CREATEDATE, LASTOPUSER, 
      LASTOPDATE)
    values (#{indexid,jdbcType=VARCHAR}, #{attDate,jdbcType=TIMESTAMP}, #{userid,jdbcType=VARCHAR}, 
      #{count,jdbcType=DECIMAL}, #{status,jdbcType=DECIMAL}, #{orgid,jdbcType=DECIMAL}, 
      #{creator,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, #{lastOpUser,jdbcType=VARCHAR}, 
      #{lastOpDate,jdbcType=TIMESTAMP})
  </insert>
  
  <update id="updateByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.AttendanceIndex" >
    update ATTENDANCE_INDEX
    set 
      COUNT = #{count,jdbcType=DECIMAL},
      CREATOR = #{creator,jdbcType=VARCHAR},
      LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
      LASTOPDATE = #{lastOpDate,jdbcType=TIMESTAMP}
    where INDEXID = #{indexid,jdbcType=VARCHAR}
  </update>
  <select id="getList" parameterType="map" resultMap="BaseResultMap" >
  	select 
    t.INDEXID, t.ATT_DATE, t.ATT_USERID, t.COUNT, t.STATUS, t.FK_ORGID, t.CREATOR, t.CREATEDATE, t.LASTOPUSER, 
    t.LASTOPDATE, o.NAME, h.TRUENAME as ATT_NAME,
    <include refid="getSummary"/>, 
    <include refid="getResult" />
    from ATTENDANCE_INDEX t,ORGANIZATION o,HQXT_USER h
    where t.status=0 and t.FK_ORGID=o.ORGID and h.userid=t.att_userid
    <if test="beginDate !=null">
    	and t.ATT_DATE >= #{beginDate,jdbcType=TIMESTAMP}
    </if>
    <if test="endDate !=null">
    	and t.ATT_DATE &lt;= #{endDate,jdbcType=TIMESTAMP}
    </if>
    <if test="summary != null and summary ==0">
    	and t.COUNT=(select count(1) from ATTENDANCE_DETAIL d 
    				 where d.FK_INDEXID=t.INDEXID and d.RESULT=0)
    </if>
    <if test="summary != null and summary ==1">
    	and t.COUNT=(select count(1) from ATTENDANCE_DETAIL d 
    				 where d.FK_INDEXID=t.INDEXID and d.RESULT in (1,2,3))
    </if>
    <if test="summary != null and summary ==2">
    	and t.COUNT>(select count(1) from ATTENDANCE_DETAIL d 
    				 where d.FK_INDEXID=t.INDEXID and d.RESULT=0)
    </if>
    <if test="name != null and name !=''">
    	and exists (select 1 from practice_user p where o.ORGID=p.FK_ORGID and instr(p.name,#{name,jdbcType=VARCHAR})>0)
    </if>
    <choose>
  		<when test="isManager == null">
  			and t.FK_ORGID = #{orgid,jdbcType=DECIMAL}
  		</when>
  		<otherwise>
  			<!-- 是食堂管理员，获取学校机构id,再获取学校所有食堂机构id,获取在该学校食堂的人员 -->
  			and 
			instr(','||(select ob.fk_orgids from ORG_BELONG ob 
						where instr(','||ob.fk_orgids||',' , 
						','||#{orgid,jdbcType=DECIMAL}||',')>0) ||',' , ','||t.FK_ORGID||',')>0
  		</otherwise>
  	</choose>
    order by <include refid="orderBy"/>
  </select>
  
  
</mapper>