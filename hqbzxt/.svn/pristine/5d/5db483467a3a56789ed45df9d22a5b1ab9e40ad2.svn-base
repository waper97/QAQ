<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.order.OrderFormMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.order.OrderForm" >
    <id column="ID" property="id" jdbcType="VARCHAR" />
    <result column="ADDTIME" property="addTime" jdbcType="TIMESTAMP" />
    <result column="DELETESTATUS" property="deleteStatus" jdbcType="DECIMAL" />
    <result column="MSG" property="msg" jdbcType="VARCHAR" />
    <result column="ORDER_NO" property="orderNo" jdbcType="VARCHAR" />
    <result column="SORTINGNO" property="sortingNo" jdbcType="VARCHAR" />
    <result column="ORDER_STATUS" property="orderStatus" jdbcType="DECIMAL" />
    <result column="ORDER_TYPE" property="orderType" jdbcType="DECIMAL" />
    <result column="EXPECT_RECV_BEGIN_TIME" property="expectRecvBeginTime" jdbcType="TIMESTAMP" />
    <result column="EXPECT_RECV_END_TIME" property="expectRecvEndTime" jdbcType="TIMESTAMP" />
    <result column="SHIP_PRICE" property="shipPrice" jdbcType="DECIMAL" />
    <result column="TOTAL" property="total" jdbcType="DECIMAL" />
    <result column="OUT_TOTAL" property="outTotal" jdbcType="DECIMAL" />
    <result column="COST_TOTAL" property="costTotal" jdbcType="DECIMAL" />
    <result column="RECEIVE_TOTAL" property="receiveTotal" jdbcType="DECIMAL" />
    <result column="STORE_ID" property="storeid" jdbcType="DECIMAL" />
    <result column="STORE_NAME" property="storeName" jdbcType="VARCHAR" />
    <result column="USER_ID" property="userid" jdbcType="VARCHAR" />
    <result column="USER_NAME" property="userName" jdbcType="VARCHAR" />
    <result column="PARENT_ID" property="parentid" jdbcType="VARCHAR" />
    <result column="ORG_ID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORG_NAME" property="orgName" jdbcType="VARCHAR" />
    <result column="RECEIVER" property="receiver" jdbcType="VARCHAR" />
    <result column="RECEIVER_MOBILE" property="receiverMobile" jdbcType="VARCHAR" />
    <result column="RECEIVER_ADDRESS" property="receiverAddress" jdbcType="VARCHAR" />
    <result column="PAY_STATUS" property="payStatus" jdbcType="DECIMAL" />
    <result column="PAYDATE" property="payDate" jdbcType="TIMESTAMP" />
    <result column="DELIVERY_DATE" property="deliveryDate" jdbcType="TIMESTAMP" />
    <result column="RECEIVE_DATE" property="receiveDate" jdbcType="TIMESTAMP" />
    <result column="DETAIL_TOTAL" property="detailTotal" jdbcType="DECIMAL" />
    <result column="RETURN_TOTAL" property="returnTotal" jdbcType="DECIMAL" />
    <result column="RECORD_COUNT" property="recordCount" jdbcType="DECIMAL" />
    <result column="TRACE_STATUS" property="traceStatus" jdbcType="DECIMAL" />
    
  </resultMap>
  <sql id="Base_Column_List" >
    ID, ADDTIME, DELETESTATUS,MSG, ORDER_NO, SORTINGNO, ORDER_STATUS, ORDER_TYPE, EXPECT_RECV_BEGIN_TIME, 
    EXPECT_RECV_END_TIME, SHIP_PRICE, TOTAL, OUT_TOTAL, COST_TOTAL, RECEIVE_TOTAL, STORE_ID, 
    USER_ID, PARENT_ID, ORG_ID, RECEIVER, RECEIVER_MOBILE, RECEIVER_ADDRESS, PAY_STATUS, 
    PAYDATE
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from ORDERFORM
    where ID = #{id,jdbcType=VARCHAR}
  </select>
  
  <select id="getReceiveListForDistributor" resultMap="BaseResultMap" parameterType="java.util.Map">
  	select o.id,o.order_no,o.org_id,orz.name as ORG_NAME,o.order_type ,
  	o.addtime ,o.order_status ,o.total,o.ship_price,o.receive_total 
    from order_detail od 
    left join ORDERFORM o on o.id=od.fk_orderid  
    left join ORGANIZATION orz on o.org_id=orz.orgid
    where o.deletestatus=0 
    and o.order_status=#{orderStatus,jdbcType=DECIMAL}
    and o.store_id=#{orgid,jdbcType=DECIMAL}
  	
    order by o.addtime desc
  </select>
  
  <select id="getOrderListForSeller" resultMap="BaseResultMap" parameterType="java.util.Map">
  	select o.id,o.order_no,o.store_id,org.name as STORE_NAME,o.org_id,orz.name as ORG_NAME,o.order_type ,
  	o.addtime ,o.order_status ,o.total,o.ship_price,o.out_total,o.cost_total,o.receive_total,o.pay_status,
    sum(od.return_qty*od.price_basic) as RETURN_TOTAL,count(1) as RECORD_COUNT  from order_detail od 
    left join ORDERFORM o on o.id=od.fk_orderid  
    left join ORGANIZATION org on o.store_id=org.orgid
    left join ORGANIZATION orz on o.org_id=orz.orgid
    where o.deletestatus=0 
    <if test="orgid!=-1">
    	and o.store_id=#{orgid,jdbcType=DECIMAL}
    </if>    
    <if test="beginTime!=null and beginTime!=''">
  		<![CDATA[ and o.ADDTIME >= to_date(#{beginTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if>
  	<if test="endTime!=null and endTime!=''">
  		<![CDATA[ and o.ADDTIME <= to_date(#{endTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if> 
  	<if test="orderNo!=null and orderNo!=''">
  		 and instr(o.order_no,#{orderNo,jdbcType=VARCHAR})>0
  	</if>
  	<if test="buyerOrgName!=null and buyerOrgName!=''">
  		 and instr(orz.name,#{buyerOrgName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="sellerOrgName!=null and sellerOrgName!=''">
  		 and instr(org.name,#{sellerOrgName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="orderStatus!=null">
  		 and o.order_status=#{orderStatus,jdbcType=DECIMAL}
  	</if>
  	<if test="orderType!=null">
  		 and o.order_type=#{orderType,jdbcType=DECIMAL}
  	</if>
  	<if test="payStatus!=null">
  		 and o.pay_status=#{payStatus,jdbcType=DECIMAL}
  	</if>
  	<if test="traceStatus!=null">
  		<choose>
    		<when test="traceStatus==0">
    			and ORDER_STATUS=20
    		</when>
    		<otherwise>
        		and ORDER_STATUS &gt;= 30
    		</otherwise>
		</choose>
  	</if>
    group by o.id,o.order_no,o.store_id,o.org_id,o.order_type,
  	o.addtime,o.order_status ,o.total,o.ship_price,o.out_total,
  	o.cost_total,o.receive_total,o.pay_status,org.name,orz.name
  	order by o.addtime desc
  </select>
  
  <insert id="addOrderForm" parameterType="com.yj.hqbz.model.order.OrderForm">
    insert into ORDERFORM (ID,ADDTIME,MSG,ORDER_NO,SORTINGNO,ORDER_STATUS,ORDER_TYPE,
      EXPECT_RECV_BEGIN_TIME,EXPECT_RECV_END_TIME,SHIP_PRICE,STORE_ID,USER_ID,ORG_ID,
      RECEIVER,RECEIVER_MOBILE,RECEIVER_ADDRESS,TOTAL)
    VALUES
      (#{id,jdbcType=VARCHAR},sysdate,#{msg,jdbcType=VARCHAR},#{orderNo,jdbcType=VARCHAR},#{sortingNo,jdbcType=VARCHAR},
      #{orderStatus,jdbcType=DECIMAL},#{orderType,jdbcType=DECIMAL},#{expectRecvBeginTime,jdbcType=TIMESTAMP},
      #{expectRecvEndTime,jdbcType=TIMESTAMP},#{shipPrice,jdbcType=DECIMAL},#{storeid,jdbcType=DECIMAL},
      #{userid,jdbcType=VARCHAR},#{orgid,jdbcType=DECIMAL},#{receiver,jdbcType=VARCHAR},#{receiverMobile,jdbcType=VARCHAR},
      #{receiverAddress,jdbcType=VARCHAR},#{total,jdbcType=DECIMAL})
  </insert>
  
  <update id="updateReceiver" parameterType="java.util.Map">
  	update ORDERFORM
  		<set>
  			RECEIVER = #{receiver,jdbcType=VARCHAR},		
  			RECEIVER_MOBILE = #{receiverMobile,jdbcType=VARCHAR},
  			RECEIVER_ADDRESS = #{receiverAddress,jdbcType=VARCHAR}
  		</set>
  		where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <update id="updateOrder" parameterType="com.yj.hqbz.model.order.OrderForm">
  	update ORDERFORM
  	<set>
  		<if test="sortingNo!=null and sortingNo!=''">
  			SORTINGNO = #{sortingNo,jdbcType=VARCHAR},
  		</if>
  		<if test="orderStatus!=null">
  			ORDER_STATUS = #{orderStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="outTotal!=null">
  			OUT_TOTAL = #{outTotal,jdbcType=DECIMAL},
  		</if>
  		<if test="costTotal!=null">
  			COST_TOTAL = #{costTotal,jdbcType=DECIMAL},
  		</if>
  		<if test="receiveTotal!=null">
  			RECEIVE_TOTAL = #{receiveTotal,jdbcType=DECIMAL},
  		</if>
  		<if test="payStatus!=null">
  			PAY_STATUS = #{payStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="payDate!=null">
  			PAYDATE = #{payDate,jdbcType=TIMESTAMP},
  		</if>
  		<if test="deliveryDate!=null">
  			DELIVERY_DATE = #{deliveryDate,jdbcType=TIMESTAMP},
  		</if>
  		<if test="receiveDate!=null">
  			RECEIVE_DATE = #{receiveDate,jdbcType=TIMESTAMP},
  		</if>
  		<if test="total!=null">
  			TOTAL = #{total,jdbcType=DECIMAL}
  		</if>
  	</set>
  	where ID = #{id,jdbcType=VARCHAR}
  </update>
  
  <select id="getBuyerOrderListByUser" parameterType="java.util.Map" resultMap="BaseResultMap">
  	select o.id ,o.order_no,o.store_id as ORG_ID ,org.name as ORG_NAME,order_type ,
  	o.addtime ,o.order_status ,o.total,o.ship_price,
  	o.receive_total 
  	from ORDERFORM o left join ORGANIZATION org on o.store_id=org.orgid 
  	where o.user_id=#{userid,jdbcType=VARCHAR} and o.DELETESTATUS=0
  	<if test="orderStatus!=null">
  		<choose>
    		<when test="orderStatus==0 or orderStatus==40">
    			<choose>
    				<when test="orderStatus==0">
    					and (ORDER_STATUS = 0 or ORDER_STATUS= 5)
    				</when>
    				<otherwise>
    					and (ORDER_STATUS = 40 or ORDER_STATUS= 50)
    				</otherwise>
    			</choose> 			
    		</when>
    		<otherwise>
        		and ORDER_STATUS = #{orderStatus,jdbcType=DECIMAL}
    		</otherwise>
		</choose>
  	</if>
	order by o.addTime desc,o.id desc 
  </select>
  
  <select id="getOrderForDetail" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select o.id ,o.order_no,o.store_id,org.name as STORE_NAME,o.org_id,orz.name as ORG_NAME, order_type ,
  	o.addtime ,o.order_status ,o.total,o.ship_price,o.msg,
  	o.receive_total, EXPECT_RECV_BEGIN_TIME,EXPECT_RECV_END_TIME,RECEIVER,RECEIVER_MOBILE,RECEIVER_ADDRESS,
  	count(1) as RECORD_COUNT
  	from ORDERFORM o 
  	left join ORGANIZATION org on o.store_id=org.orgid
  	left join ORGANIZATION orz on o.org_id=orz.orgid
  	left join order_detail od on od.fk_orderid=o.id
  	where ID = #{id,jdbcType=VARCHAR} and od.deletestatus=0
  	group by o.id,o.order_no,o.store_id,o.org_id,o.order_type,o.msg,
  	o.addtime,o.order_status ,o.total,o.ship_price,o.receive_total,
  	EXPECT_RECV_BEGIN_TIME,EXPECT_RECV_END_TIME,RECEIVER,RECEIVER_MOBILE,RECEIVER_ADDRESS,org.name,orz.name
  </select>
  
  
  <update id="deleteOrder" parameterType="com.yj.hqbz.model.order.OrderForm">
  	 update ORDERFORM set DELETESTATUS=1 where ID = #{id,jdbcType=VARCHAR} 
  </update>
  
  <select id="getOrderFormByDetailid" parameterType="java.lang.String" resultMap="BaseResultMap">
     select o.*,od.qty*od.price as DETAIL_TOTAL from ORDERFORM o left join ORDER_DETAIL od on o.ID = od.FK_ORDERID
	 where od.DETAIL_ID=#{detailid,jdbcType=VARCHAR} and od.DELETESTATUS=0
  </select>
  
  <select id="getNotTraceNumByOrderid" parameterType="java.lang.String" resultType="java.lang.Integer">
  	 select count(1) from order_detail od 
     where od.fk_orderid=#{orderid,jdbcType=VARCHAR} and od.trace_status=0 and od.deletestatus=0
  </select>
  
  <select id="getOutTotalAndCostTotalByOrderid" parameterType="java.lang.String" resultMap="BaseResultMap">
  	 select sum(od.out_qty*od.price_basic) as OUT_TOTAL,sum(od.out_qty*od.costprice_basic) as COST_TOTAL from order_detail od 
   	 where od.fk_orderid=#{orderid,jdbcType=VARCHAR} and od.deletestatus=0
  </select>
  
  <select id="getReceiveTotalByOrderid"  parameterType="java.lang.String" resultMap="BaseResultMap">
  	select sum(od.real_qty*od.price_basic) as RECEIVE_TOTAL from order_detail od 
   	where od.fk_orderid=#{orderid,jdbcType=VARCHAR} and od.deletestatus=0
  </select>
  
  <select id="getOrderCountByUser" parameterType="java.lang.String" resultMap="BaseResultMap">
  	select sum(o.total - sum(od.return_qty*od.price_basic)) as TOTAL,count(1) as RECORD_COUNT  
  	   from order_detail od 
       left join ORDERFORM o on o.id=od.fk_orderid  
       where o.deletestatus=0 and od.deletestatus=0 and o.USER_ID=#{userid,jdbcType=VARCHAR}
       and o.order_status &gt;= 60
    group by o.total
  </select>
  
  
</mapper>