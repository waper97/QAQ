<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.order.OrderDetailMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.order.OrderDetail" >
    <id column="DETAIL_ID" property="detailid" jdbcType="VARCHAR" />
    <result column="FK_ORDERID" property="orderid" jdbcType="VARCHAR" />
    <result column="ORG_SKUID" property="orgSkuid" jdbcType="VARCHAR" />
    <result column="QTY" property="qty" jdbcType="DECIMAL" />
    <result column="QTY_BASIC" property="qtyBasic" jdbcType="DECIMAL" />
    <result column="UNIT" property="unit" jdbcType="VARCHAR" />
    <result column="AUIXUNIT" property="auixUnit" jdbcType="VARCHAR" />
    <result column="PRICE" property="price" jdbcType="DECIMAL" />
    <result column="PRICE_BASIC" property="priceBasic" jdbcType="DECIMAL" />
    <result column="COSTPRICE" property="costprice" jdbcType="DECIMAL" />
    <result column="COSTPRICE_BASIC" property="costpriceBasic" jdbcType="DECIMAL" />
    <result column="DETAIL_STATUS" property="detailStatus" jdbcType="DECIMAL" />
    <result column="ADDTIME" property="addTime" jdbcType="TIMESTAMP" />
    <result column="OUT_QTY" property="outQty" jdbcType="DECIMAL" />
    <result column="REAL_QTY" property="realQty" jdbcType="DECIMAL" />
    <result column="SPEC_INFO" property="specInfo" jdbcType="VARCHAR" />
    <result column="DIFF_STATUS" property="diffStatus" jdbcType="DECIMAL" />
    <result column="DIFF_QTY" property="diffQty" jdbcType="DECIMAL" />
    <result column="DIFF_DESC" property="diffDesc" jdbcType="VARCHAR" />
    <result column="CREATE_PURCHASE_ORDER" property="createPurchaseOrder" jdbcType="DECIMAL" />
    <result column="INSTORE_STATUS" property="instoreStatus" jdbcType="DECIMAL" />
    <result column="INSTORE_DATE" property="instoreDate" jdbcType="TIMESTAMP" />
    <result column="RETURN_QTY" property="returnQty" jdbcType="DECIMAL" />
    <result column="RETURN_REAL_QTY" property="returnRealQty" jdbcType="DECIMAL" />
    <result column="DELETESTATUS" property="deleteStatus" jdbcType="DECIMAL" /> 
    <result column="TRACE_STATUS" property="traceStatus" jdbcType="DECIMAL" />     
    <result column="BUSINESSATTR" property="businessAttr" jdbcType="DECIMAL" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="ALIASNAME" property="aliasName" jdbcType="VARCHAR" />
    <result column="PROPERTY" property="property" jdbcType="VARCHAR" />
    <result column="REAL_TOTAL" property="realTotal" jdbcType="DECIMAL" />
    <result column="TOTAL" property="total" jdbcType="DECIMAL" />
    <result column="OUTTOTAL" property="outTotal" jdbcType="DECIMAL" />  
    <result column="PICURL" property="picUrl" jdbcType="VARCHAR" />
    <result column="THUMBNAILURL" property="thumbnailUrl" jdbcType="VARCHAR" />
    <result column="DIFF_TOTAL" property="diffTotal" jdbcType="DECIMAL" />
    <result column="RECORD_COUNT" property="recordCount" jdbcType="DECIMAL" />
    <result column="SORTNO" property="sortNo" jdbcType="VARCHAR" />
    <result column="GOODSID" property="goodsid" jdbcType="VARCHAR" />
    
  </resultMap>
  
  <sql id="Base_Column_List" >
    DETAIL_ID, FK_ORDERID, ORG_SKUID, QTY, QTY_BASIC, UNIT, AUIXUNIT, PRICE, PRICE_BASIC, 
    COSTPRICE, COSTPRICE_BASIC, DETAIL_STATUS, ADDTIME, OUT_QTY, REAL_QTY, SPEC_INFO, DIFF_STATUS, 
    DIFF_QTY, DIFF_DESC,CREATE_PURCHASE_ORDER,INSTORE_STATUS, INSTORE_DATE, RETURN_QTY, RETURN_REAL_QTY,
    DELETESTATUS,TRACE_STATUS
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from ORDER_DETAIL
    where DETAIL_ID = #{detailid,jdbcType=VARCHAR}
  </select>
  
  <insert id="addOrderDetail" parameterType="com.yj.hqbz.model.order.OrderDetail">
  	 insert into ORDER_DETAIL
  	 (<include refid="Base_Column_List" />)
  	 values
  	 (#{detailid,jdbcType=VARCHAR},#{orderid,jdbcType=VARCHAR},#{orgSkuid,jdbcType=VARCHAR},#{qty,jdbcType=DECIMAL},
  	 #{qtyBasic,jdbcType=DECIMAL},#{unit,jdbcType=VARCHAR},#{auixUnit,jdbcType=VARCHAR},#{price,jdbcType=DECIMAL},
  	 #{priceBasic,jdbcType=DECIMAL},#{costprice,jdbcType=DECIMAL},#{costpriceBasic,jdbcType=DECIMAL},#{detailStatus,jdbcType=DECIMAL},sysdate,
  	 #{outQty,jdbcType=DECIMAL},#{realQty,jdbcType=DECIMAL},#{specInfo,jdbcType=VARCHAR},#{diffStatus,jdbcType=DECIMAL},
  	 #{diffQty,jdbcType=DECIMAL},#{diffDesc,jdbcType=VARCHAR},#{createPurchaseOrder,jdbcType=DECIMAL},#{instoreStatus,jdbcType=DECIMAL},
  	 #{instoreDate,jdbcType=TIMESTAMP},#{returnQty,jdbcType=DECIMAL},#{returnRealQty,jdbcType=DECIMAL},#{deleteStatus,jdbcType=DECIMAL},
  	 #{traceStatus,jdbcType=DECIMAL})
  </insert>
  
  <select id="getCartListForOrder" resultMap="BaseResultMap" parameterType="java.util.Map">
  	select 
    gt.businessattr as BUSINESSATTR,g.unit as UNIT,os.price as PRICE,
    gc.count as QTY,os.price_basic as PRICE_BASIC,os.unit as AUIXUNIT,
    os.costprice_basic as COSTPRICE_BASIC,
    os.id as ORG_SKUID,gc.count*os.rate as QTY_BASIC,os.spec_info as SPEC_INFO,os.costprice as COSTPRICE
    from goodscart gc left join org_sku os on gc.skuid=os.id
    left join storecart sc on sc.store_id=os.fk_orgid
    left join SKU s on s.skuid=os.fk_skuid
    left join goods g on s.fk_goodsid=g.goodsid 
    left join goodstype gt on gt.typeid=os.fk_goodstypeid
    where sc.user_id=#{userid,jdbcType=VARCHAR} and sc.id=gc.fk_scid and os.fk_orgid = #{orgid,jdbcType=DECIMAL} and gc.id in 
    <foreach collection="gcList" open="(" separator="," close=")" item="item">
	  	#{item}
	</foreach>
  </select>
  
  <select id="getBuyNowInfoForOrder" resultMap="BaseResultMap" parameterType="java.lang.Integer">
    select 
    gt.businessattr as BUSINESSATTR,g.unit as UNIT,os.price as PRICE,
    os.price_basic as PRICE_BASIC,os.unit as AUIXUNIT,
    os.costprice_basic as COSTPRICE_BASIC,
    os.id as ORG_SKUID,os.rate as QTY_BASIC,os.spec_info as SPEC_INFO,os.costprice as COSTPRICE
    from org_sku os    
    left join SKU s on s.skuid=os.fk_skuid
    left join goods g on s.fk_goodsid=g.goodsid 
    left join goodstype gt on gt.typeid=os.fk_goodstypeid
    where os.id=#{orgSkuid,jdbcType=DECIMAL} 
  </select>
  
  <select id="getDetailListByOrderid" resultMap="BaseResultMap" parameterType="java.lang.String">
  	select od.detail_id ,od.org_skuid ,g.goodsname as GOODSNAME,g.goodsid as GOODSID,
  	g.aliasname as ALIASNAME,s.property as PROPERTY,od.unit,od.spec_info,
	od.qty ,od.qty_basic ,od.price ,od.price_basic,od.auixunit,od.OUT_QTY,
    sp.pic_url as PICURL,sp.thumbnail_url as THUMBNAILURL,od.REAL_QTY,od.DIFF_QTY, od.DIFF_QTY*od.price_basic as DIFF_TOTAL,
    od.qty*od.price as TOTAL,od.DIFF_STATUS,od.DIFF_DESC,od.DETAIL_STATUS
  	from ORDER_DETAIL od
  	left join ORG_SKU os on od.org_skuid=os.id
	left join SKU s on s.skuid=os.fk_skuid
	left join goods g on g.goodsid=s.fk_goodsid
	left join skupic sp on s.skuid=sp.fk_skuid
  	where FK_ORDERID = #{orderid,jdbcType=VARCHAR} and od.DELETESTATUS=0
  </select>
  
  <update id="updateOrderDetail" parameterType="com.yj.hqbz.model.order.OrderDetail">
  	update ORDER_DETAIL
  	<set>
  		<if test="detailStatus!=null">
  			DETAIL_STATUS = #{detailStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="outQty!=null">
  			OUT_QTY = #{outQty,jdbcType=DECIMAL},
  		</if>
  		<if test="realQty!=null">
  			REAL_QTY = #{realQty,jdbcType=DECIMAL},
  		</if>
  		<if test="diffStatus!=null">
  			DIFF_STATUS = #{diffStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="diffQty!=null">
  			DIFF_QTY = #{diffQty,jdbcType=DECIMAL},
  		</if>
  		<if test="diffDesc!=null and diffDesc!=''">
  			DIFF_DESC = #{diffDesc,jdbcType=VARCHAR},
  		</if>
  		<if test="createPurchaseOrder!=null">
  			CREATE_PURCHASE_ORDER = #{createPurchaseOrder,jdbcType=DECIMAL},
  		</if>
  		<if test="instoreStatus!=null">
  			INSTORE_STATUS = #{instoreStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="instoreDate!=null">
  			INSTORE_DATE = #{instoreDate,jdbcType=TIMESTAMP}
  		</if>
  		<if test="returnQty!=null">
  			RETURN_QTY = #{returnQty,jdbcType=DECIMAL},
  		</if>
  		<if test="returnRealQty!=null">
  			RETURN_REAL_QTY = #{returnRealQty,jdbcType=VARCHAR},
  		</if>
  		<if test="deleteStatus!=null">
  			DELETESTATUS = #{deleteStatus,jdbcType=DECIMAL},
  		</if>
  		<if test="traceStatus!=null">
  			TRACE_STATUS = #{traceStatus,jdbcType=DECIMAL}
  		</if>
  	</set>
  	where DETAIL_ID = #{detailid,jdbcType=VARCHAR}
  </update>
  
  <select id="getOrderDetailByOrderid" resultMap="BaseResultMap" parameterType="java.lang.String">
  	select od.detail_id,od.org_skuid,g.goodsname as GOODSNAME,g.aliasname as ALIASNAME,s.property as PROPERTY,g.goodsid as GOODSID,
    od.unit,od.spec_info,od.qty,od.qty_basic,od.real_qty,od.price,od.price_basic,od.out_qty,od.return_qty,od.COSTPRICE,od.COSTPRICE_BASIC,
    od.return_real_qty,od.auixunit,sp.pic_url as PICURL,sp.thumbnail_url as THUMBNAILURL,od.detail_status,od.diff_status,
    od.real_qty*od.price_basic as REAL_TOTAL, od.out_qty*od.price_basic as OUTTOTAL,od.TRACE_STATUS,od.DIFF_DESC    
    from ORDER_DETAIL od 
    left join ORG_SKU os on od.org_skuid=os.id
    left join SKU s on s.skuid=os.fk_skuid
    left join goods g on g.goodsid=s.fk_goodsid
    left join skupic sp on s.skuid=sp.fk_skuid 
	where od.FK_ORDERID=#{orderid,jdbcType=VARCHAR} and od.DELETESTATUS=0
  </select>
  
  <select id="getDetailQtyByOrderid" resultMap="BaseResultMap" parameterType="java.lang.String">
  	select od.ORG_SKUID, od.QTY from ORDER_DETAIL od 
	left join ORDERFORM o on o.id = od.fk_orderid
  	where o.id=#{orderid,jdbcType=VARCHAR}
  </select>
  
  <select id="getDiffDetailNumByOrderid" parameterType="java.lang.String" resultType="java.lang.Integer">
  	select count(1) from ORDER_DETAIL  where FK_ORDERID=#{orderid,jdbcType=VARCHAR}
  	and diff_status &lt; 4 and DELETESTATUS=0
  </select>
  
  <select id="getTraceByGoods" parameterType="java.util.Map" resultMap="BaseResultMap">
  	 select g.goodsname as GOODSNAME,g.aliasname as ALIASNAME,s.property as PROPERTY, 
  	 sum(od.qty_basic) as qty_basic,od.unit as unit,s.skuid as ORG_SKUID
     from order_detail od 
     left join orderform o on od.fk_orderid=o.id
     left join ORG_SKU os on od.org_skuid=os.id
     left join SKU s on s.skuid=os.fk_skuid
     left join goods g on g.goodsid=s.fk_goodsid
     left join ORGANIZATION org on o.store_id=org.orgid
     where od.deletestatus=0 and o.deletestatus=0
     <if test="beginTime!=null and beginTime!=''">
  		<![CDATA[ and o.ADDTIME >= to_date(#{beginTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if>
  	<if test="endTime!=null and endTime!=''">
  		<![CDATA[ and o.ADDTIME <= to_date(#{endTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if> 
  	<if test="goodsName!=null and goodsName!=''">
  		 and instr(g.goodsname,#{goodsName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="buyerOrgName!=null and buyerOrgName!=''">
  		 and instr(org.name,#{buyerOrgName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="orgid!=-1">
  	     and o.STORE_ID=#{orgid,jdbcType=DECIMAL}
  	</if>
  	<if test="traceStatus!=null">
  		<choose>
    		<when test="traceStatus==0">
    			and od.TRACE_STATUS=0
    		</when>
    		<otherwise>
        		and od.TRACE_STATUS=1
    		</otherwise>
		</choose>
  	</if>  
  	<if test="orderStatus!=null">
  		<choose>
    		<when test="orderStatus==0">
    			and o.ORDER_STATUS = 20
    		</when>
    		<otherwise>
        		and o.ORDER_STATUS = 30
    		</otherwise>
		</choose>
  	</if>
     group by g.goodsname,g.aliasname ,s.property ,od.unit,s.skuid
     order by g.goodsname
  </select>
  
  <select id="getTraceGoodsDetail" parameterType="java.util.Map" resultMap="BaseResultMap">
  	 select o.sortingno as sortno,od.out_qty,od.unit,od.trace_status,
     od.qty_basic ,od.auixunit,od.spec_info,od.DETAIL_ID
     from order_detail od 
     left join orderform o on od.fk_orderid=o.id
     left join ORG_SKU os on od.org_skuid=os.id
     left join SKU s on s.skuid=os.fk_skuid
     left join goods g on g.goodsid=s.fk_goodsid
     left join ORGANIZATION org on o.store_id=org.orgid
     where od.deletestatus=0 and o.deletestatus=0 and s.skuid=#{skuid,jdbcType=VARCHAR} 
     <if test="beginTime!=null and beginTime!=''">
  		<![CDATA[ and o.ADDTIME >= to_date(#{beginTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if>
  	<if test="endTime!=null and endTime!=''">
  		<![CDATA[ and o.ADDTIME <= to_date(#{endTime,jdbcType=DATE},'yyyy-MM-dd hh24:mi:ss')]]>
  	</if> 
  	<if test="goodsName!=null and goodsName!=''">
  		 and instr(g.goodsname,#{goodsName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="buyerOrgName!=null and buyerOrgName!=''">
  		 and instr(org.name,#{buyerOrgName,jdbcType=VARCHAR})>0
  	</if>
  	<if test="orgid!=-1">
  	     and o.STORE_ID=#{orgid,jdbcType=DECIMAL}
  	</if>
  	<if test="traceStatus!=null">
  		<choose>
    		<when test="traceStatus==0">
    			and od.TRACE_STATUS=0
    		</when>
    		<otherwise>
        		and od.TRACE_STATUS=1
    		</otherwise>
		</choose>
  	</if>  
  	<if test="orderStatus!=null">
  		<choose>
    		<when test="orderStatus==0">
    			and o.ORDER_STATUS=20
    		</when>
    		<otherwise>
        		and o.ORDER_STATUS &gt;= 30
    		</otherwise>
		</choose>
  	</if>
  </select>
  
  <select id="getOrderDetailByTraceid" resultMap="BaseResultMap" parameterType="java.lang.String">
      select gt.*
      from GOODS_TRACE gt,order_detail od
      where gt.FK_ORDER_DETAILID = od.DETAIL_ID
      and gt.ID = ${traceid}      
  </select>
  
</mapper>