<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.schoolOperation.PracticeUserMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    <id column="USERID" property="userid" jdbcType="VARCHAR" />
    <result column="USER_CODE" property="userCode" jdbcType="VARCHAR" />
    <result column="NAME" property="name" jdbcType="VARCHAR" />
    <result column="SEX" property="sex" jdbcType="DECIMAL" />
    <result column="PHONE" property="phone" jdbcType="VARCHAR" />
    <result column="BIRTHDAY" property="birthday" jdbcType="TIMESTAMP" />
    <result column="ENTRY_DATE" property="entryDate" jdbcType="TIMESTAMP" />
    <result column="BEGIN_DATE" property="beginDate" jdbcType="TIMESTAMP" />
    <result column="END_DATE" property="endDate" jdbcType="TIMESTAMP" />
    <result column="PIC_URL" property="picUrl" jdbcType="VARCHAR" />
    <result column="THUMBNAIL_URL" property="thumbnailUrl" jdbcType="VARCHAR" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATEDATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="LASTOPUSER" property="lastOpUser" jdbcType="VARCHAR" />
    <result column="LASTOPDATE" property="lastOpDate" jdbcType="TIMESTAMP" />
    <result column="CREDENTIAL_URL" property="credentialUrl" jdbcType="VARCHAR" />
    <result column="CREDENTAIL_THUM_URL" property="credentailThumUrl" jdbcType="VARCHAR" />
    <result column="WARNING" property="warning" jdbcType="DECIMAL" />
  </resultMap>
  <sql id="Base_Column_List" >
    USERID, USER_CODE, NAME, SEX, PHONE, BIRTHDAY, ENTRY_DATE, BEGIN_DATE, END_DATE, 
    PIC_URL, THUMBNAIL_URL, FK_ORGID, STATUS, CREATOR, CREATEDATE, LASTOPUSER, 
    LASTOPDATE,CREDENTIAL_URL,CREDENTAIL_THUM_URL
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select 
    <include refid="Base_Column_List" />
    from PRACTICE_USER
    where USERID = #{userid,jdbcType=VARCHAR}
  </select>
  <delete id="deleteByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    update PRACTICE_USER 
    set STATUS=#{status,jdbcType=DECIMAL},
	    LASTOPUSER=#{lastOpUser,jdbcType=VARCHAR},
	    LASTOPDATE=#{lastOpDate,jdbcType=TIMESTAMP}
    where USERID = #{userid,jdbcType=VARCHAR}
  </delete>
  <insert id="insert" parameterType="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    insert into PRACTICE_USER (USERID, USER_CODE, NAME, 
      SEX, PHONE, BIRTHDAY, 
      ENTRY_DATE, BEGIN_DATE, END_DATE, 
      PIC_URL, THUMBNAIL_URL, 
      FK_ORGID, STATUS, CREATOR, 
      CREATEDATE, LASTOPUSER, LASTOPDATE,CREDENTIAL_URL,CREDENTAIL_THUM_URL
      )
    values (#{userid,jdbcType=VARCHAR}, 
    (select nvl(TRIM(to_char(max(to_number(USER_CODE))+1,'000009')),'000001') from PRACTICE_USER), 
      #{name,jdbcType=VARCHAR}, 
      #{sex,jdbcType=DECIMAL}, #{phone,jdbcType=VARCHAR}, #{birthday,jdbcType=TIMESTAMP}, 
      #{entryDate,jdbcType=TIMESTAMP}, #{beginDate,jdbcType=TIMESTAMP}, #{endDate,jdbcType=TIMESTAMP}, 
      #{picUrl,jdbcType=VARCHAR}, #{thumbnailUrl,jdbcType=VARCHAR}, 
      #{orgid,jdbcType=DECIMAL}, #{status,jdbcType=DECIMAL}, #{creator,jdbcType=VARCHAR}, 
      #{createDate,jdbcType=TIMESTAMP}, #{lastOpUser,jdbcType=VARCHAR}, #{lastOpDate,jdbcType=TIMESTAMP},
      #{credentialUrl,jdbcType=VARCHAR},#{credentailThumUrl,jdbcType=VARCHAR}
      )
  </insert>
  <insert id="insertSelective" parameterType="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    insert into PRACTICE_USER
    <trim prefix="(" suffix=")" suffixOverrides="," >
      <if test="userid != null" >
        USERID,
      </if>
      <if test="userCode != null" >
        USER_CODE,
      </if>
      <if test="name != null" >
        NAME,
      </if>
      <if test="sex != null" >
        SEX,
      </if>
      <if test="phone != null" >
        PHONE,
      </if>
      <if test="birthday != null" >
        BIRTHDAY,
      </if>
      <if test="entryDate != null" >
        ENTRY_DATE,
      </if>
      <if test="beginDate != null" >
        BEGIN_DATE,
      </if>
      <if test="endDate != null" >
        END_DATE,
      </if>
      <if test="picUrl != null" >
        PIC_URL,
      </if>
      <if test="thumbnailUrl != null" >
        THUMBNAIL_URL,
      </if>
      <if test="orgid != null" >
        FK_ORGID,
      </if>
      <if test="status != null" >
        STATUS,
      </if>
      <if test="creator != null" >
        CREATOR,
      </if>
      <if test="createDate != null" >
        CREATEDATE,
      </if>
      <if test="lastOpUser != null" >
        LASTOPUSER,
      </if>
      <if test="lastOpDate != null" >
        LASTOPDATE,
      </if>
      <if test="credentialUrl != null" >
        CREDENTIAL_URL,
      </if>
      <if test="credentailThumUrl != null" >
        CREDENTAIL_THUM_URL,
      </if>
    </trim>
    <trim prefix="values (" suffix=")" suffixOverrides="," >
      <if test="userid != null" >
        #{userid,jdbcType=VARCHAR},
      </if>
      <if test="userCode != null" >
        #{userCode,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        #{name,jdbcType=VARCHAR},
      </if>
      <if test="sex != null" >
        #{sex,jdbcType=DECIMAL},
      </if>
      <if test="phone != null" >
        #{phone,jdbcType=VARCHAR},
      </if>
      <if test="birthday != null" >
        #{birthday,jdbcType=TIMESTAMP},
      </if>
      <if test="entryDate != null" >
        #{entryDate,jdbcType=TIMESTAMP},
      </if>
      <if test="beginDate != null" >
        #{beginDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null" >
        #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="picUrl != null" >
        #{picUrl,jdbcType=VARCHAR},
      </if>
      <if test="thumbnailUrl != null" >
        #{thumbnailUrl,jdbcType=VARCHAR},
      </if>
      <if test="orgid != null" >
        #{orgid,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        #{status,jdbcType=DECIMAL},
      </if>
      <if test="creator != null" >
        #{creator,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastOpUser != null" >
        #{lastOpUser,jdbcType=VARCHAR},
      </if>
      <if test="lastOpDate != null" >
        #{lastOpDate,jdbcType=TIMESTAMP},
      </if>
      <if test="credentialUrl != null" >
        #{credentialUrl,jdbcType=VARCHAR},
      </if>
      <if test="credentailThumUrl != null" >
        #{credentailThumUrl,jdbcType=VARCHAR},
      </if>
    </trim>
  </insert>
  <update id="updateByPrimaryKeySelective" parameterType="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    update PRACTICE_USER
    <set >
      <if test="userCode != null" >
        USER_CODE = #{userCode,jdbcType=VARCHAR},
      </if>
      <if test="name != null" >
        NAME = #{name,jdbcType=VARCHAR},
      </if>
      <if test="sex != null" >
        SEX = #{sex,jdbcType=DECIMAL},
      </if>
      <if test="phone != null" >
        PHONE = #{phone,jdbcType=VARCHAR},
      </if>
      <if test="birthday != null" >
        BIRTHDAY = #{birthday,jdbcType=TIMESTAMP},
      </if>
      <if test="entryDate != null" >
        ENTRY_DATE = #{entryDate,jdbcType=TIMESTAMP},
      </if>
      <if test="beginDate != null" >
        BEGIN_DATE = #{beginDate,jdbcType=TIMESTAMP},
      </if>
      <if test="endDate != null" >
        END_DATE = #{endDate,jdbcType=TIMESTAMP},
      </if>
      <if test="picUrl != null" >
        PIC_URL = #{picUrl,jdbcType=VARCHAR},
      </if>
      <if test="thumbnailUrl != null" >
        THUMBNAIL_URL = #{thumbnailUrl,jdbcType=VARCHAR},
      </if>
      <if test="orgid != null" >
        FK_ORGID = #{orgid,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="creator != null" >
        CREATOR = #{creator,jdbcType=VARCHAR},
      </if>
      <if test="createDate != null" >
        CREATEDATE = #{createDate,jdbcType=TIMESTAMP},
      </if>
      <if test="lastOpUser != null" >
        LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
      </if>
      <if test="lastOpDate != null" >
        LASTOPDATE = #{lastOpDate,jdbcType=TIMESTAMP},
      </if>
      <if test="credentialUrl != null" >
        CREDENTIAL_URL = #{credentialUrl,jdbcType=VARCHAR},
      </if>
      <if test="credentailThumUrl != null" >
        CREDENTAIL_THUM_URL = #{credentailThumUrl,jdbcType=VARCHAR},
      </if>
    </set>
    where USERID = #{userid,jdbcType=VARCHAR}
  </update>
  <update id="updateByPrimaryKey" parameterType="com.yj.hqbz.model.schoolOperation.PracticeUser" >
    update PRACTICE_USER
    set 
      NAME = #{name,jdbcType=VARCHAR},
      SEX = #{sex,jdbcType=DECIMAL},
      PHONE = #{phone,jdbcType=VARCHAR},
      BIRTHDAY = #{birthday,jdbcType=TIMESTAMP},
      ENTRY_DATE = #{entryDate,jdbcType=TIMESTAMP},
      BEGIN_DATE = #{beginDate,jdbcType=TIMESTAMP},
      END_DATE = #{endDate,jdbcType=TIMESTAMP},
      PIC_URL = #{picUrl,jdbcType=VARCHAR},
      THUMBNAIL_URL = #{thumbnailUrl,jdbcType=VARCHAR},
      LASTOPUSER = #{lastOpUser,jdbcType=VARCHAR},
      LASTOPDATE = #{lastOpDate,jdbcType=TIMESTAMP},
      CREDENTIAL_URL = #{credentialUrl,jdbcType=VARCHAR},
      CREDENTAIL_THUM_URL = #{credentailThumUrl,jdbcType=VARCHAR}
    where USERID = #{userid,jdbcType=VARCHAR}
  </update>
  <select id="getList" parameterType="map" resultMap="BaseResultMap" >
  select p.*,o.NAME as ORGNAME,floor(MONTHS_BETWEEN (add_months(sysdate,1), BIRTHDAY) / 12)as age,
  	case when add_months(sysdate,1)>=end_date then 1 
  		 else 0 end as WARNING
  	from PRACTICE_USER p,ORGANIZATION o
  	where p.FK_ORGID=o.ORGID and p.status = 0
  	<if test="name != null and name != ''">
  		and instr(p.NAME,#{name,jdbcType=VARCHAR})>0
  	</if>
  	<if test="beginDate != null">
  		and p.END_DATE>=#{beginDate,jdbcType=TIMESTAMP}
  	</if>
  	<if test="endDate != null">
  		and p.END_DATE &lt;=#{endDate,jdbcType=TIMESTAMP}
  	</if>
    <if test="entryBeginDate != null">
      and p.ENTRY_DATE>=#{entryBeginDate,jdbcType=TIMESTAMP}
    </if>
    <if test="entryEndDate != null">
      and p.ENTRY_DATE &lt;=#{entryEndDate,jdbcType=TIMESTAMP}
    </if>
  	<choose>
  		<when test="isManager == null">
  			and p.FK_ORGID = #{orgid,jdbcType=DECIMAL}
  		</when>
  		<otherwise>
  			<!-- 是食堂管理员，获取学校机构id,再获取学校所有食堂机构id,获取在该学校食堂的人员 -->
  			and 
			instr(','||(select ob.fk_orgids from ORG_BELONG ob 
						where instr(','||ob.fk_orgids||',' , 
						','||#{orgid,jdbcType=DECIMAL}||',')>0) ||',' , ','||p.FK_ORGID||',')>0
  		</otherwise>
  	</choose>
  	<if test="sex != null">
  		and p.SEX=#{sex,jdbcType=DECIMAL}
  	</if>
  	<if test="entryDate != null">
  		and p.ENTRY_DATE=#{entryDate,jdbcType=TIMESTAMP}
  	</if>
    order by case
      <![CDATA[
         when WARNING = 1 and age >=50  then 0
        when WARNING = 1 and age <50 then 1
        when WARNING = 0 and age >=50  then 2
        when WARNING = 0 and age <50  then 3
        end , p.USER_CODE desc
      ]]>
    <!--排序规则：1.健康证到期预警>年龄到期预警>(健康证到期时间预警和年龄到期时间预警同事存在时，健康证到期预警排在前面然后是年龄到期预警)未到期 2.编号倒序-->
    <!--<order by (p.END_DATE-sysdate) asc ,(sysdate-p.BIRTHDAY) desc , p.USER_CODE desc-->

  </select>
  
</mapper>