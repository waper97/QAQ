<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.yj.hqbz.mapper.order.PurchaseIndexMapper" >
  <resultMap id="BaseResultMap" type="com.yj.hqbz.model.order.PurchaseIndex" >
    <id column="ID" property="orderid" jdbcType="VARCHAR" />
    <result column="ORDER_NO" property="orderNo" jdbcType="VARCHAR" />
    <result column="TOTAL" property="total" jdbcType="DECIMAL" />
    <result column="FK_ORGID" property="orgid" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="FK_USERID" property="userid" jdbcType="VARCHAR" />
    <result column="USERNAME" property="username" jdbcType="VARCHAR" />
    <result column="TASKCOUNT" property="taskCount" jdbcType="DECIMAL" />
    <result column="STATUS" property="status" jdbcType="DECIMAL" />
    <result column="DELETESTATUS" property="deleteStatus" jdbcType="DECIMAL" />
    <result column="FK_CARETORID" property="caretorid" jdbcType="VARCHAR" />
    <result column="CREATOR" property="creator" jdbcType="VARCHAR" />
    <result column="CREATE_DATE" property="createDate" jdbcType="TIMESTAMP" />
    <result column="SUBMIT_DATE" property="submitDate" jdbcType="TIMESTAMP" />
  </resultMap>
  
  
  <resultMap id="TaskResultMap" type="com.yj.hqbz.model.order.PurchaseTask" >
    <result column="orderDetailid" property="orderDetailid" jdbcType="VARCHAR" />
    <result column="SEPC_INFO" property="sepcInfo" jdbcType="VARCHAR" />
    <result column="ORG_SKUID" property="orgSkuid" jdbcType="VARCHAR" />
    <result column="SKUID" property="skuid" jdbcType="VARCHAR" />
    <result column="GOODSNAME" property="goodsName" jdbcType="VARCHAR" />
    <result column="ORGID" property="orgId" jdbcType="DECIMAL" />
    <result column="ORGNAME" property="orgName" jdbcType="VARCHAR" />
    <result column="ALIASNAME" property="aliasName" jdbcType="VARCHAR" />
    <result column="SPEC_INFO" property="specInfo" jdbcType="VARCHAR" />
    <result column="unit" property="unit" jdbcType="VARCHAR" />
    <result column="PROPERTY" property="property" jdbcType="VARCHAR" />
    <result column="AUIXUNIT" property="auixUnit" jdbcType="VARCHAR" />
    <result column="AUIXRATE" property="auixRate" jdbcType="DECIMAL" />
    <result column="QTY" property="qty" jdbcType="DECIMAL" />
    <result column="QTY_BASIC" property="qtyBasic" jdbcType="DECIMAL" />
    <result column="PRICE_BASIC" property="priceBasic" jdbcType="DECIMAL" />
  </resultMap>
  
  <sql id="Base_Column_List" >
    ID, ORDER_NO, TOTAL, FK_ORGID, FK_USERID, USERNAME, TASKCOUNT, STATUS, DELETESTATUS, 
    FK_CARETORID, CREATOR, CREATE_DATE, SUBMIT_DATE
  </sql>
  
  <sql id="param">
  	<if test="beginTime!=null">
  		and a.CREATE_DATE >= #{beginTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="endTime!=null">
  		and a.CREATE_DATE &lt;= #{endTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="orderNo!=null and orderNo!=''">
  		and a.ORDER_NO = #{orderNo,jdbcType=VARCHAR}
  	</if>  	
  	<if test="status!=null">
  		and a.STATUS = #{status,jdbcType=DECIMAL}
  	</if>
  	<if test="orgid!=null">
  		and a.FK_ORGID = #{orgid,jdbcType=DECIMAL}
  	</if>
  </sql>
  
  <sql id="orderBy">
  	<choose>
  		<when test="orderBy!=null and orderBy!=''">
  			<choose>
		  		<when test="orderBy=='buyerOrgName' or orderBy=='orgName' or orderBy=='userName'">
		  			NLSSORT(#{orderBy},'NLS_SORT=SCHINESE_PINYIN_M') 
		  		</when>
		  		<otherwise>
		  			#{orderBy}
		  		</otherwise>
		  	</choose>
		  	<if test="orderType==1">
		  		desc
		  	</if>
  		</when>
  		<otherwise>
  			CREATE_DATE
  		</otherwise>
  	</choose>
  </sql>
  
  <select id="selectBillList" resultMap="BaseResultMap" parameterType="java.util.Map">
  	select * from (
	  	select a.*,o.name as ORGNAME
	    from PURCHASE_INDEX a,ORGANIZATION o
	    where a.FK_ORGID = o.ORGID
	    <include refid="param"/>
	   )
	   order by <include refid="orderBy"/>
  </select>
  
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.String" >
    select a.*,o.name as ORGNAME
    from PURCHASE_INDEX a,ORGANIZATION o
    where a.ID = #{id,jdbcType=VARCHAR}
    and a.FK_ORGID = o.ORGID
  </select>
  
  
  
  <insert id="insert" parameterType="com.yj.hqbz.model.order.PurchaseIndex" >
    insert into PURCHASE_INDEX (ID, ORDER_NO, TOTAL, 
      FK_ORGID, FK_USERID, USERNAME, 
      TASKCOUNT, STATUS, DELETESTATUS, 
      FK_CARETORID, CREATOR, CREATE_DATE, 
      SUBMIT_DATE)
    values (#{orderid,jdbcType=VARCHAR}, #{orderNo,jdbcType=VARCHAR}, #{total,jdbcType=DECIMAL}, 
      #{orgid,jdbcType=DECIMAL}, #{userid,jdbcType=VARCHAR}, #{username,jdbcType=VARCHAR}, 
      #{taskCount,jdbcType=DECIMAL}, #{status,jdbcType=DECIMAL}, #{deleteStatus,jdbcType=DECIMAL}, 
      #{caretorid,jdbcType=VARCHAR}, #{creator,jdbcType=VARCHAR}, #{createDate,jdbcType=TIMESTAMP}, 
      #{submitDate,jdbcType=TIMESTAMP})
  </insert>
  
  <update id="updateByPrimaryKeySelective" parameterType="com.yj.hqbz.model.order.PurchaseIndex" >
    update PURCHASE_INDEX
    <set >
      <if test="total != null" >
        TOTAL = #{total,jdbcType=DECIMAL},
      </if>
      <if test="taskCount != null" >
        TASKCOUNT = #{taskCount,jdbcType=DECIMAL},
      </if>
      <if test="status != null" >
        STATUS = #{status,jdbcType=DECIMAL},
      </if>
      <if test="submitDate != null" >
        SUBMIT_DATE = #{submitDate,jdbcType=TIMESTAMP},
      </if>
      <if test="userid!=null">
      	FK_USERID = #{userid,jdbcType=TIMESTAMP},
      </if>
      <if test="username!=null">
      	USERNAME = #{username,jdbcType=TIMESTAMP},
      </if>
    </set>
    where ID = #{orderid,jdbcType=VARCHAR}
  </update>
  
  <select id="getPurchaseTaskList" resultMap="TaskResultMap" parameterType="java.util.Map">
  	select od.org_skuid,orgsku.spec_info,orgsku.unit as auixunit,orgsku.rate as auixrate,
	sku.property,g.aliasname,g.goodsname,g.unit,od.price_basic,seller.ORGID, seller.name as ORGNAME,sum(od.qty) as QTY,sum(od.qty_basic) AS QTY_BASIC
	from ORDERFORM o,ORDER_DETAIL od,ORG_SKU orgsku,SKU sku,GOODS g,ORGANIZATION buyer,ORGANIZATION seller
	where o.ID=od.FK_ORDERID
	and o.ORDER_STATUS=20
	and od.CREATE_PURCHASE_ORDER = 0
	and od.org_skuid=orgsku.id
	and orgsku.fk_skuid = sku.skuid
	and sku.fk_goodsid=g.goodsid
	and o.ORG_ID = buyer.ORGID
	and o.STORE_ID = seller.ORGID
	<if test="beginTime!=null">
  		and o.ADDTIME >= #{beginTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="endTime!=null">
  		and o.ADDTIME &lt;= #{endTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="orderNo!=null and orderNo!=''">
  		and o.ORDER_NO = #{orderNo,jdbcType=VARCHAR}
  	</if>
  	<if test="orderType!=null">
  		and o.ORDER_TYPE = #{orderType,jdbcType=VARCHAR}
  	</if>  
  	<if test="orgid!=null">
  		and o.STORE_ID = #{orgid,jdbcType=DECIMAL}
  	</if>
  	<if test="buyerOrgName!=null">
  		and instr(buyer.name,#{scopeType,jdbcType=VARCHAR})>0
  	</if>
  	<if test="sellerOrgName!=null and sellerOrgName!=''">
  		and instr(seller.name,#{sellerOrgName,jdbcType=VARCHAR})>0
  	</if>  	
	group by od.org_skuid,orgsku.spec_info,orgsku.unit,seller.ORGID,
	orgsku.rate,sku.property,g.aliasname,g.goodsname,g.unit,od.price_basic,seller.name
	order by seller.ORGID
  </select>
  
  <select id="getPurchaseTaskOrderDetailsId" resultType="java.lang.String" parameterType="java.util.Map">
  	select od.detail_id
	from ORDERFORM o,ORDER_DETAIL od,ORG_SKU orgsku,SKU sku,GOODS g,ORGANIZATION buyer,ORGANIZATION seller
	where o.ID=od.FK_ORDERID
	and o.ORDER_STATUS=20
	and od.CREATE_PURCHASE_ORDER = 0
	and od.org_skuid=orgsku.id
	and orgsku.fk_skuid = sku.skuid
	and sku.fk_goodsid=g.goodsid
	and o.ORG_ID = buyer.ORGID
	and o.STORE_ID = seller.ORGID
	<if test="orgSkuid!=null">
	    and orgsku.id= #{orgSkuid,jdbcType=VARCHAR}
	</if>
	<if test="beginTime!=null">
  		and o.ADDTIME >= #{beginTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="endTime!=null">
  		and o.ADDTIME &lt;= #{endTime,jdbcType=TIMESTAMP}
  	</if>
  	<if test="orderNo!=null and orderNo!=''">
  		and o.ORDER_NO = #{orderNo,jdbcType=VARCHAR}
  	</if>
  	<if test="orderType!=null">
  		and o.ORDER_TYPE = #{orderType,jdbcType=VARCHAR}
  	</if>  
  	<if test="orgid!=null">
  		and o.STORE_ID = #{orgid,jdbcType=DECIMAL}
  	</if>
  	<if test="buyerOrgName!=null">
  		and instr(buyer.name,#{scopeType,jdbcType=VARCHAR})>0
  	</if>
  	<if test="sellerOrgName!=null and sellerOrgName!=''">
  		and instr(seller.name,#{sellerOrgName,jdbcType=VARCHAR})>0
  	</if>  
  </select>
  
  <select id="getPurchaseTaskOrderSellerOrganizationBySelectedItem" resultType="java.lang.Integer" parameterType="java.util.Map">
  	select distinct o.STORE_ID
	from ORDERFORM o,ORDER_DETAIL od
	where o.ID=od.FK_ORDERID
	and od.detail_id in
	 <foreach collection="detailIdList" open="(" separator="," close=")" item="item">
	  	#{item}
	 </foreach>  
  </select>
  
  <select id="getPurchaseTaskOrderDetailsBySelectedItem" resultMap="TaskResultMap" parameterType="java.util.Map">
  	select od.org_skuid,orgsku.spec_info,orgsku.unit as auixunit,orgsku.rate as auixrate,sku.skuid,
	sku.property,g.aliasname,g.goodsname,g.unit,od.price_basic,sum(od.qty) as QTY,sum(od.qty_basic) AS QTY_BASIC
	from ORDERFORM o,ORDER_DETAIL od,ORG_SKU orgsku,SKU sku,GOODS g
	where o.ID=od.FK_ORDERID
	and o.ORDER_STATUS=20
	and od.CREATE_PURCHASE_ORDER = 0
	and od.org_skuid=orgsku.id
	and orgsku.fk_skuid = sku.skuid
	and sku.fk_goodsid=g.goodsid	
  	<if test="orgid!=null">
  		and o.STORE_ID = #{orgid,jdbcType=DECIMAL}
  	</if>
  	and od.detail_id in
	 <foreach collection="detailIdList" open="(" separator="," close=")" item="item">
	  	#{item}
	 </foreach>  
	and od.org_skuid in
	 <foreach collection="skuIdList" open="(" separator="," close=")" item="item">
	  	#{item}
	 </foreach>  
	 
	group by od.org_skuid,orgsku.spec_info,orgsku.unit,sku.skuid,
	orgsku.rate,sku.property,g.aliasname,g.goodsname,g.unit,od.price_basic
  
  </select>
  
</mapper>